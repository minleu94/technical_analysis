# PySide6 UI 模組

## 概述

`ui_qt/` 是基於 PySide6 的現代化圖形界面，提供比 Tkinter 更強大的功能和更好的用戶體驗。

## 架構設計原則

### 1. UI 層只做三件事

- ✅ 收參數（UI state）
- ✅ 呼叫 service
- ✅ 顯示 DTO / DataFrame

### 2. 禁止在 UI 層做的事

- ❌ 讀 CSV
- ❌ 算指標
- ❌ 合併資料
- ❌ 寫推薦理由

所有業務邏輯都在 `app_module/` 服務層。

### 3. 表格使用 Model/View 架構

使用 `PandasTableModel` 提供：
- 排序
- 欄位隱藏
- Filter/Search（未來）
- 點 row → detail panel（未來）

### 4. 背景任務統一走 Worker

使用 `TaskWorker` 或 `ProgressTaskWorker` 處理：
- 推薦分析
- 回測
- 更新資料
- 參數最佳化

## 目錄結構

```
ui_qt/
├── __init__.py
├── main.py                    # 主應用程式入口
├── views/
│   ├── update_view.py         # 數據更新視圖
│   ├── market_regime_view.py  # 大盤指數視圖（三層資訊架構）
│   ├── strong_stocks_view.py  # 強勢個股視圖
│   ├── strong_industries_view.py # 強勢產業視圖
│   ├── weak_stocks_view.py    # 弱勢個股視圖（Phase 2-B）
│   ├── weak_industries_view.py # 弱勢產業視圖（Phase 2-B）
│   ├── recommendation_view.py # 推薦分析視圖（Phase 3.1：新手/進階模式、Profiles、Why Not）
│   ├── watchlist_view.py      # 觀察清單視圖（Phase 2-A）
│   ├── backtest_view.py       # 策略回測視圖
│   └── dashboard_view.py      # Dashboard 視圖（MVP）
├── models/
│   └── pandas_table_model.py  # Pandas DataFrame 的 Qt Model
├── workers/
│   └── task_worker.py         # 統一背景任務 Worker
└── widgets/
    ├── chart_widget.py        # 圖表組件
    └── info_button.py         # 資訊按鈕組件
```

## 當前實現

### 數據更新視圖 (UpdateView)

**功能**：
- 數據狀態檢查：以三個獨立區塊顯示每日股票數據、大盤指數、產業指數的最新日期、總記錄數和狀態
- 更新配置：
  - 更新類型選擇：每日股票數據、大盤指數數據、產業指數數據
  - 查找範圍設置：用於檢查指定天數內缺失的日期（預設10天）
  - 結束日期：更新數據的結束日期（預設今天）
  - 說明文字：字體更大、留白更少，提升可讀性
- 操作按鈕：
  - **開始更新**：根據查找範圍檢查缺失日期並下載
  - **合併每日數據**：增量合併新數據到 `stock_data_whole.csv`
  - **強制重新合併**：完全重建 `stock_data_whole.csv`（紅色按鈕，謹慎使用）
- 日誌顯示：實時顯示更新進度和結果

**特點**：
- 背景執行，不阻塞 UI
- 詳細的進度顯示和錯誤處理
- 支持強制重新合併（用於數據重建）
- 數據狀態以三個並排區塊顯示，無需滾動
- 所有區域支持視窗縮放，自動調整大小

### 市場觀察視圖

**大盤指數視圖 (MarketRegimeView)**：
- 顯示市場狀態（`RegimeService.detect_regime`）
- **三層資訊架構**（2025-12-22 重新設計）：
  - **Layer 1（市場結論層）**：市場狀態名稱作為唯一視覺錨點（24pt，分類色），信心度緊貼顯示，簡短描述
    - 市場狀態名稱：24pt 粗體，使用分類色（Trend=深綠、Reversion=橙、Breakout=藍）
    - 信心度：11pt 常規字體，緊貼市場狀態顯示，根據信心度高低使用不同顏色
    - 簡短描述：10pt 次要文字，說明該市場狀態的特徵
  - **Layer 2（判斷摘要層）**：人類可讀的語句解釋判斷依據，與 Layer 1 並排顯示（60:40 比例）
    - 使用自然語言解釋為什麼判斷為該市場狀態
    - 字級較小（9pt），視覺降級，不搶 Layer 1 的焦點
  - **Layer 3（技術細節層）**：可折疊，展開後並排顯示所有指標與數值
    - 預設收合，點擊 checkbox 展開
    - 包含：價格與均線、趨勢指標、評分與貢獻、其他指標、判斷條件
    - 使用並排 GroupBox 顯示，便於對比
- **深色主題優化**：
  - 統一深色背景（#1e1e1e），文字使用淺色確保可讀性
  - 顏色語意分離：分類色（Tag Color）僅用於狀態名稱，中性色用於其他文字
  - 信心度顏色：高信心度=白色（加粗），中信心度=接近白色，低信心度=淺灰
- **策略建議**：根據市場狀態自動顯示建議策略配置（下半部分，50% 高度）
- **手動檢測**：點擊「檢測市場狀態」按鈕才會執行檢測，不自動執行

**強勢個股視圖 (StrongStocksView)**：
- 顯示強勢股列表（`ScreeningService.get_strong_stocks`）
- 支持時間範圍切換（本日/本周）
- **緩存機制**：切換時間範圍時使用緩存，避免重複計算
- 支持手動刷新（強制重新計算）
- 表格支持排序


**強勢產業視圖 (StrongIndustriesView)**：
- 顯示強勢產業列表（`ScreeningService.get_strong_industries`）
- 支持時間範圍切換（本日/本周）
- **緩存機制**：切換時間範圍時使用緩存，避免重複計算
- 支持手動刷新（強制重新計算）
- 表格支持排序

**弱勢個股視圖 (WeakStocksView)**（Phase 2-B 新增）：
- 顯示弱勢股列表（與強勢股同架構，反向排名）
- 支持時間範圍切換（本日/本周）
- **緩存機制**：切換時間範圍時使用緩存，避免重複計算
- 支持手動刷新（強制重新計算）
- 表格支持排序
- **整合觀察清單**：弱勢股可加入觀察清單（用於反向策略或風險監控）

**弱勢產業視圖 (WeakIndustriesView)**（Phase 2-B 新增）：
- 顯示弱勢產業列表（與強勢產業同架構，反向排名）
- 支持時間範圍切換（本日/本周）
- **緩存機制**：切換時間範圍時使用緩存，避免重複計算
- 支持手動刷新（強制重新計算）
- 表格支持排序

**推薦分析視圖 (RecommendationView)**：
- **新手/進階模式切換**（Phase 3.1 新增）：
  - **新手模式**（預設）：
    - 只顯示 Profile 選擇和說明，隱藏詳細參數配置
    - 提供 3 個預設 Profile：暴衝策略、穩健策略、長期策略
    - 每個 Profile 包含完整配置和說明（適用市場狀態、風險等級）
    - 一鍵套用 Profile 配置
  - **進階模式**：
    - 顯示完整的技術指標、圖形模式、篩選條件配置面板
    - 支持自定義所有參數
- **策略配置**：
  - **技術指標**：7個選項（RSI、MACD、KD、移動平均線、ADX、布林通道、ATR）
    - 按交易意圖分類：趨勢類、動能類、波動/風險類
    - 每個指標都有 tooltip 說明（系統角色、適用場景）
  - **圖形模式**：12個選項（W底、頭肩底、雙底、V形反轉、圓底、矩形、三角形、旗形、楔形、頭肩頂、雙頂、圓頂）
    - 按交易意圖分類：反轉類、上漲延續類、盤整/區間類、下跌訊號類
    - 每個圖形都有 tooltip 說明
  - **策略傾向提示**：根據選擇的指標/圖形動態顯示策略傾向（趨勢追蹤/反轉/盤整/延續/混合）
  - 市場狀態顯示（自動檢測）
  - 篩選條件（漲幅、成交量、產業）
- **推薦結果顯示**：
  - 表格顯示推薦股票（支援排序）
  - **推薦理由詳情（Why）**：單擊或雙擊表格中的股票行，在下方顯示詳細推薦理由
    - 格式化顯示：關鍵詞高亮（技術指標、圖形模式、標籤）
    - 顯示觸發來源：可反推使用了哪些指標/圖形
  - **Why Not（反向解釋）**（Phase 3.1 新增）：
    - 顯示可能影響排名的因素
    - 顯示各子分數與理想值的差距
    - 顯示篩選條件符合情況
    - 顯示市場狀態匹配情況
  - 左右分割比例：策略配置 40%，推薦結果 60%
  - 上下分割比例：推薦結果表格 70%，推薦理由詳情 30%
- **整合觀察清單**：推薦結果可加入觀察清單，保留來源信息（Profile/時間/Regime）
- **結果保存**：推薦結果可保存到 ResultStore，包含完整 meta 信息（Profile/時間/Regime/配置）

**觀察清單管理器 (WatchlistView)**：
- **UI 布局**：上下分割設計（主要工作區 70%，管理操作區 30%）
  - 上方主要工作區：觀察清單表格（顯示所有股票）
  - 下方管理操作區：左右分割
    - 左側：觀察清單操作按鈕（刷新、新增、移除、清空、保存為選股清單）
    - 右側：選股清單管理（用於回測）
- **核心功能**：
  - 跨 Tab 共用候選池管理
  - 股票來源追蹤（market_watch、recommendation、manual）
  - 備註與標籤管理
  - 新增/移除/清空功能
  - 支援從 DataFrame 批量新增
- **選股清單管理**（與策略回測整合）：
  - 保存當前觀察清單為選股清單
  - 從選股清單載入到觀察清單
  - 選股清單 CRUD（創建、編輯、刪除）
  - 選股清單列表顯示

**策略回測視圖 (BacktestView)**：
- **完整的策略回測實驗室功能**，提供從策略開發到結果分析的完整工作流程

#### 核心功能

**1. 策略管理**
- 策略預設管理（儲存/載入/刪除）
- 動態策略參數表單（根據策略定義自動生成）
- 策略描述顯示

**2. 選股與配置**
- 選股清單管理（單一股票/批次模式）
- 選股清單創建/編輯/刪除（支援多檔股票）
- 回測配置（日期範圍、初始資金、交易成本、風險控制）

**3. 部位與市場限制**
- 部位 Sizing 模式：
  - 全倉模式
  - 固定金額模式
  - 風險百分比模式（基於 ATR）
- 市場限制：
  - 漲跌停限制（台股真實限制）
  - 成交量約束（最大參與率）

**4. 參數最佳化**
- Grid Search（參數掃描）
- 支援多參數組合最佳化
- 目標指標選擇（CAGR、Sharpe、MDD、CAGR-MDD）
- 背景執行，不阻塞 UI

**5. Walk-forward 驗證**
- Train-Test Split（訓練/測試切分）
- Rolling Walk-forward（滾動驗證）
- 防止過擬合

**6. 回測執行**
- 單一股票回測
- 批次回測（多檔股票同時回測）
- 批次回測進度顯示（文字 + 進度條）
- 背景執行，支援取消

**7. 結果管理**
- 回測結果保存（自動命名：股票_策略_日期時間）
- 回測歷史列表（顯示所有保存的結果）
- 回測歷史刪除（支援多選刪除）
- 結果載入與重跑

**8. 結果比較**
- 多個回測結果並排比較
- 績效指標對比（CAGR、Sharpe、MDD、勝率、交易次數、PF）
- 排序與篩選

**9. 批次結果**
- 批次回測排行榜（顯示所有股票的績效）
- 可排序（CAGR、Sharpe、MDD、CAGR-MDD）
- 整體統計（成功數、賺錢數、中位數 CAGR/MDD）
- **雙擊載入**：雙擊排行榜行自動載入該股票的詳細結果

**10. 圖表視覺化**
- 權益曲線（Equity Curve）
- 回撤曲線（Drawdown Curve）
- 單筆交易報酬分佈（Trade Return Histogram）
- 持有天數分佈（Holding Period Histogram）
- 支援繁體中文顯示
- 可切換不同回測結果查看

**11. 結果展示**
- 績效摘要（總報酬、年化報酬、Sharpe、MDD、勝率、交易次數）
- 交易明細表格（買賣點、報酬率、持有天數）
- 支援排序與篩選

**詳細功能請參考**：`策略回測功能清單.md`

## 運行方式

```bash
# 確保已安裝 PySide6
pip install PySide6

# 運行應用
python ui_qt/main.py
```

## 已實現功能

### ✅ 數據更新頁
- 數據狀態檢查
- 數據更新（支持查找範圍設置）
- 合併每日數據（增量合併）
- 強制重新合併（完全重建）
- 使用 `TaskWorker` 執行更新任務

### ✅ 市場觀察頁
- **大盤指數視圖**：
  - 三層資訊架構（市場結論層、判斷摘要層、技術細節層）
  - 深色主題優化
  - 策略建議自動顯示
  - 手動檢測市場狀態
- **強勢個股視圖**（帶緩存）：
  - 支持時間範圍切換（本日/本周）
  - **整合觀察清單**：強勢股可加入觀察清單
- **強勢產業視圖**（帶緩存）：
  - 支持時間範圍切換（本日/本周）
- **弱勢個股視圖**（Phase 2-B，帶緩存）：
  - 支持時間範圍切換（本日/本周）
  - **整合觀察清單**：弱勢股可加入觀察清單
- **弱勢產業視圖**（Phase 2-B，帶緩存）：
  - 支持時間範圍切換（本日/本周）
- **推薦分析視圖**（Phase 3.1 增強）：
  - 新手/進階模式切換
  - Profiles v1（暴衝/穩健/長期）
  - Why Not（反向解釋）
  - 結果保存功能
  - **整合觀察清單**：推薦結果可加入觀察清單，保留來源信息

### ✅ 觀察清單管理器（Phase2-A 已完成 + 2025-12-20 增強）
- **UI 布局**：上下分割設計（主要工作區 70%，管理操作區 30%）
  - 上方：觀察清單表格（主要工作區）
  - 下方：管理操作區（左右分割）
    - 左側：觀察清單操作按鈕
    - 右側：選股清單管理（用於回測）
- **核心功能**：
  - 跨 Tab 共用候選池管理
  - 股票來源追蹤（market_watch、recommendation、manual）
  - 備註與標籤管理
  - 新增/移除/清空功能
  - 支援從 DataFrame 批量新增
  - JSON 持久化（WatchlistService）
- **選股清單管理**（2025-12-20 新增）：
  - 保存當前觀察清單為選股清單
  - 從選股清單載入到觀察清單
  - 選股清單 CRUD（創建、編輯、刪除）
  - 選股清單列表顯示

### ✅ 策略回測頁（完整實現）
- **策略管理**：預設保存/載入/刪除
- **選股管理**：清單創建/編輯/刪除
- **整合觀察清單**：可從觀察清單載入股票進行回測
- **回測配置**：日期、資金、成本、風險控制
- **部位 Sizing**：全倉/固定金額/風險百分比
- **市場限制**：漲跌停、成交量約束
- **參數最佳化**：Grid Search
- **Walk-forward 驗證**：Train-Test Split / Rolling
- **批次回測**：多檔股票同時回測，排行榜顯示
- **進度顯示**：批次回測實時進度（文字 + 進度條）
- **結果保存**：自動保存回測結果
- **歷史管理**：列表顯示、比較、刪除
- **雙擊載入**：批次結果雙擊載入詳細結果
- **圖表視覺化**：權益曲線、回撤曲線、報酬分佈、持有天數
- **結果展示**：摘要、明細表格、圖表
- 使用 `TaskWorker` 執行回測任務（背景執行）

## 技術特點

### 背景任務處理
- 所有耗時操作（回測、最佳化、數據更新）都在背景執行
- 使用 `TaskWorker` 統一管理背景任務
- 支援進度回調和取消操作

### 數據持久化
- 策略預設：JSON 格式
- 選股清單：JSON 格式
- **觀察清單**：JSON 格式（WatchlistService）
- 回測結果：SQLite（元數據）+ Parquet/CSV（大數據）
- 支援結果追溯和重跑

### UI 響應性
- 使用 `QSplitter` 實現可調整的左右分割
- 使用 `QScrollArea` 確保配置面板可滾動
- 使用 `QTabWidget` 組織多個結果視圖
- 支援全螢幕模式下的自動縮放

## 已完成功能狀態

### ✅ Phase 1：市場觀察儀
- ✅ 數據更新流程
- ✅ 強勢股/強勢產業分析
- ✅ 市場 Regime 判斷
- ✅ 推薦理由生成

### ✅ Phase 2：策略資料庫
- ✅ Phase2-A：跨 Tab 共用 Watchlist
- ✅ Phase2-B：Market Watch 弱勢分析（弱勢股/弱勢產業視圖）
- ✅ Phase2-C：Recommendation DTO 統一
- ✅ Phase2-D：Backtest 研究體驗補強（進度回調、參數套用）
- ✅ Phase2-E：預設策略庫

### ✅ Phase 2.5：參數設計優化
- ✅ 強勢/弱勢分數標準化
- ✅ Pattern ATR-based
- ✅ Scoring Contract 統一
- ✅ 回測參數改進（execution_price、停損停利 ATR 模式、部位管理）

### ✅ Phase 3.1：推薦可用化
- ✅ 推薦分析 Tab UI 可理解性優化
- ✅ 新手/進階模式切換
- ✅ Why Not（反向解釋）v1
- ✅ Recommendation 結果可保存
- ✅ Profiles v1（暴衝/穩健/長期）

## 未來計劃

### Phase 3.2：Profiles 正式化（待開始）
- [ ] Profiles v1 完善（風險提示、適用/不適用狀態）
- [ ] Regime → Profile 建議
- [ ] Profile meta 可追溯

### Phase 3.3：研究閉環（待開始）
- [ ] Explain 面板 v1（分數拆解 + 風險點）
- [ ] 一鍵送回測（Profile → Backtest）
- [ ] Promote（回測成果 → 可用策略版本）
- [ ] Backtest：K 線標記買賣點 v1

### Phase 4：持倉管理（待開始）
- [ ] Portfolio Tab
- [ ] 交易紀錄
- [ ] 條件監控

### Phase 5：效能與研究輸出（待開始）
- [ ] 大表格分頁
- [ ] 圖表渲染優化（PyQtGraph）
- [ ] 批次回測並行化
- [ ] 匯出研究報告（Excel / PDF）

### 性能優化
- [ ] 大數據集的分頁顯示
- [ ] 圖表渲染優化（使用 PyQtGraph）
- [ ] 批次回測並行執行

## 依賴

- PySide6 >= 6.0.0
- pandas
- app_module（服務層）


