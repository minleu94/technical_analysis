# 台灣證交所 API 調查報告

## 🔍 調查結果

### 1. 官方公告狀態
- **結論**：台灣證交所**未公開宣布** API 有重大變更
- **但發現**：
  - 2025年8月，TWSE 發布了《核心系統資訊架構標準》
  - 可能有未公開的 API 防護機制增強

### 2. API 端點測試結果

測試了所有常用的 API 端點，**全部返回 307 錯誤**：

| API 端點 | 參數 | 狀態 | 說明 |
|---------|------|------|------|
| `MI_INDEX` | `type=ALLBUT0999` | ❌ 307 | Enhanced 版本使用 |
| `MI_INDEX` | `type=ALL` | ❌ 307 | Notebook 版本使用 |
| `STOCK_DAY` | `stockNo=0050` | ❌ 307 | 單一股票查詢 |
| `MI_INDEX` | 舊日期測試 | ❌ 307 | 2024-08-28 也失敗 |

### 3. 錯誤訊息
```
頁面無法執行
THE PAGE CANNOT BE ACCESSED!
因為安全性考量，您所執行的頁面無法呈現
錯誤代碼為：N/A
```

## 💡 可能的原因

### 1. **API 防護機制增強**（最可能）
- 證交所可能加強了 API 防護
- 需要更真實的瀏覽器行為
- 可能有 IP 限制或請求頻率限制

### 2. **API 結構變更**（可能）
- 根據搜索結果，有開發者發現 API 欄位有新增（@、^、%等）
- 可能需要新的參數或認證方式

### 3. **臨時維護**（較不可能）
- 所有端點都失敗，不太像臨時維護
- 更像是系統性的防護機制

## 📊 影響範圍

### 受影響的功能
- ✅ `01_stock_data_collector.ipynb` - Notebook 版本
- ✅ `01_stock_data_collector_enhanced.py` - Enhanced 版本
- ✅ `scripts/update_stock_data.py` - 正式腳本
- ✅ `data_module/data_loader.py` - 數據加載器
- ✅ 所有使用 `MI_INDEX` API 的功能

### 不受影響的功能
- ✅ 已下載的歷史數據（`daily_price/` 目錄）
- ✅ 數據合併功能（`merge_daily_data.py`）
- ✅ 技術分析功能（使用本地數據）

## 🛠️ 解決方案建議

### 方案 1：使用 Selenium 模擬瀏覽器（推薦）
- **優點**：可以繞過大部分防護機制
- **缺點**：速度較慢，需要安裝 selenium
- **實現難度**：中等

### 方案 2：使用 FinMind API
- **優點**：穩定、可靠
- **缺點**：可能需要付費，數據格式可能不同
- **實現難度**：低（已有部分實現）

### 方案 3：手動下載
- **優點**：100% 可靠
- **缺點**：需要手動操作
- **實現難度**：無

### 方案 4：等待並重試
- **優點**：簡單
- **缺點**：不確定何時恢復
- **實現難度**：無

## 📝 建議的下一步行動

### 短期（今天）
1. ✅ 確認問題：已完成 API 端點測試
2. ⏳ 嘗試手動下載：從證交所網站下載 2025-08-28 的數據
3. ⏳ 等待 1-2 小時後重試：可能是臨時防護

### 中期（本週）
1. 🔨 實現 Selenium 方案：自動化瀏覽器操作
2. 🔨 整合 FinMind API：作為備用數據源
3. 📝 更新文檔：記錄新的 API 使用方式

### 長期（本月）
1. 🔨 建立多數據源備援機制
2. 🔨 實現自動重試和錯誤處理
3. 🔨 添加數據驗證和完整性檢查

## 🔗 相關資源

### 官方文檔
- TWSE 核心系統資訊架構標準（2025年8月）
- TWSE API 文件（需要檢查最新版本）

### 社群資源
- GitHub: VincentLiu3/TWSE
- 開發者論壇和社群

### 替代方案
- FinMind API
- yfinance（部分數據）
- 手動下載 CSV

## 📅 測試記錄

- **測試時間**：2025-12-08
- **測試日期**：2025-08-28, 2024-08-28
- **測試結果**：所有端點返回 307 錯誤
- **測試工具**：`test_api_endpoints.py`

## ⚠️ 注意事項

1. **不要頻繁重試**：可能導致 IP 被封鎖
2. **檢查官方公告**：定期查看 TWSE 官方網站
3. **備份數據**：確保現有數據已備份
4. **考慮替代方案**：準備多個數據源

