# 券商分點資料解析改進說明

## 最後更新：2026-01-02

---

## 一、問題描述

在券商分點資料更新功能中，部分對手券商名稱無法正確解析，被標記為 `UNKNOWN`：

1. **ETF 名稱無法解析**（例如：`元大台灣50`、`元大高股息`、`富邦科技`）
2. **特殊格式代號無法解析**（例如：`6643M31`、`7722LINEPAY`）
3. **純中文股票名稱無法解析**（例如：`台積電`、`聯發科`）

**影響**：`counterparty_broker_code` 被標記為 `UNKNOWN`，可能影響後續分析。

---

## 二、改進方案

### 2.1 改進的解析邏輯

改進 `_parse_counterparty_broker_name` 方法，支援以下格式：

#### 1. 標準券商格式 ✅
- **格式**：開頭數字/字母數字組合 + 中文名稱
- **範例**：`1234元大證券`、`9A00永豐證券`
- **解析結果**：`(code='1234', name='元大證券')`

#### 2. ETF 名稱 ✅
- **格式**：純中文或中文+數字，包含 ETF 關鍵詞
- **關鍵詞**：`元大`、`富邦`、`國泰`、`中信`、`台新`、`永豐`、`第一`、`兆豐`、`台灣50`、`高股息`、`科技`、`金融`、`中小`、`電子`、`傳產`、`ETF`
- **範例**：`元大台灣50`、`元大高股息`、`富邦科技`
- **解析結果**：`(code='ETF', name='元大台灣50')`

#### 3. 特殊格式（股票代號+標識）✅
- **格式**：4位數字 + 字母數字組合
- **範例**：`6643M31`、`7722LINEPAY`、`2330TSMC`
- **解析結果**：`(code='6643', name='6643M31')`

#### 4. 純中文股票名稱 ✅
- **格式**：純中文（無數字、無英文）
- **範例**：`台積電`、`聯發科`、`鴻海`
- **解析結果**：`(code='STOCK', name='台積電')`

#### 5. 純數字股票代號 ✅
- **格式**：4-6位數字
- **範例**：`2330`、`6643`
- **解析結果**：`(code='2330', name='2330')`

#### 6. 無法識別的格式
- **處理**：返回 `(code='UNKNOWN', name=原始文字)`
- **記錄**：記錄 debug 級別日誌

---

## 三、實作細節

### 3.1 改進的解析方法

**檔案**：`app_module/broker_branch_update_service.py`

**方法**：`_parse_counterparty_broker_name(text: str) -> Tuple[str, str]`

**解析順序**：
1. 嘗試標準券商格式（正則：`^([\dA-Z]+)([^\dA-Z]+.*)$`）
2. 檢查是否為 ETF 名稱（關鍵詞匹配）
3. 嘗試特殊格式（正則：`^(\d{4})([A-Z0-9]+)$`）
4. 檢查是否為純中文（正則：`^[\u4e00-\u9fff]+$`）
5. 嘗試提取開頭數字部分（正則：`^(\d{4,6})`）
6. 如果都無法解析，返回 `UNKNOWN`

### 3.2 代碼標記說明

| 代碼 | 說明 | 範例 |
|------|------|------|
| `1234` | 標準券商代碼 | `1234元大證券` |
| `ETF` | ETF 產品 | `元大台灣50` |
| `STOCK` | 純中文股票名稱 | `台積電` |
| `6643` | 股票代號（特殊格式） | `6643M31` |
| `UNKNOWN` | 無法識別的格式 | `ABC` |

---

## 四、測試驗證

### 4.1 測試腳本

**檔案**：`scripts/test_counterparty_parsing.py`

**測試案例**：18 個測試案例，涵蓋所有支援的格式

**測試結果**：✅ 18/18 通過（100% 通過率）

### 4.2 測試案例清單

1. ✅ 標準券商格式（3 個）
2. ✅ ETF 名稱（4 個）
3. ✅ 特殊格式（3 個）
4. ✅ 純中文股票名稱（3 個）
5. ✅ 純數字股票代號（2 個）
6. ✅ 邊界情況（3 個）

---

## 五、使用方式

### 5.1 分析現有資料

使用分析腳本檢查現有資料中的 UNKNOWN 模式：

```bash
python scripts/analyze_unknown_counterparties.py
```

**輸出**：
- 統計所有 UNKNOWN 記錄
- 分類分析（ETF、特殊格式、純中文等）
- 詳細報告（CSV 格式）

### 5.2 測試解析邏輯

使用測試腳本驗證解析邏輯：

```bash
python scripts/test_counterparty_parsing.py
```

**輸出**：
- 測試結果（通過/失敗）
- 詳細測試報告

### 5.3 重新處理資料（可選）

如果需要重新處理現有資料，可以：

1. 刪除現有 CSV 檔案
2. 重新執行資料下載
3. 使用改進後的解析邏輯處理新資料

---

## 六、改進效果

### 6.1 預期改進

- ✅ **ETF 名稱**：從 `UNKNOWN` 改為 `ETF` 代碼
- ✅ **特殊格式**：從 `UNKNOWN` 改為股票代號（如 `6643`）
- ✅ **純中文股票名稱**：從 `UNKNOWN` 改為 `STOCK` 代碼
- ✅ **解析準確率**：預期從 ~70% 提升到 ~95%

### 6.2 向後兼容

- ✅ 現有資料不受影響（已保存的 CSV 檔案保持不變）
- ✅ 新下載的資料使用改進後的解析邏輯
- ✅ `UNKNOWN` 代碼仍然保留（用於無法識別的格式）

---

## 七、相關檔案

### 7.1 核心檔案

- `app_module/broker_branch_update_service.py`：解析邏輯實作
- `scripts/test_counterparty_parsing.py`：測試腳本
- `scripts/analyze_unknown_counterparties.py`：分析腳本

### 7.2 相關文檔

- `BROKER_BRANCH_TESTING_AND_TROUBLESHOOTING.md`：測試與故障排除指南（同目錄）
- `BROKER_BRANCH_DATA_MODULE_DESIGN_V2.md`：設計文檔（同目錄）
- `../00_core/DEVELOPMENT_ROADMAP.md`：開發路線圖

---

## 八、後續改進建議

### 8.1 可選改進

1. **建立 ETF 對照表**：如果需要更精確的 ETF 識別，可以建立 ETF 名稱對照表
2. **建立股票代號對照表**：如果需要將股票代號轉換為股票名稱，可以建立對照表
3. **改進特殊格式識別**：如果發現更多特殊格式，可以擴展解析邏輯

### 8.2 資料品質監控

建議定期執行分析腳本，監控資料品質：

```bash
# 每週執行一次
python scripts/analyze_unknown_counterparties.py
```

---

**最後更新**：2026-01-02  
**維護者**：系統開發團隊

