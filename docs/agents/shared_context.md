# 共用上下文 - 不可違背前提

> **所有 Agent 必須遵守的專案規範與前提條件**

## 🎯 核心原則

### 1. 資料完整性優先
- **絕對不可刪除或修改原始資料檔案**（`data/raw/`, `data/daily_price/` 等）
- 所有資料處理必須是**非破壞性**的
- 資料驗證失敗時，必須**停止執行**並報告問題

### 2. 向後相容性
- **不可破壞現有功能**
- API 變更必須保持向後相容，或提供明確的遷移路徑
- 移除功能前必須先確認沒有其他地方使用

### 3. 測試覆蓋
- **關鍵功能必須有測試**
- 修改現有功能時，必須更新或新增對應測試
- 測試失敗時不可合併代碼

### 4. 文檔同步
- **代碼變更必須同步更新文檔**
- API 變更必須更新對應的使用文檔
- 新增功能必須更新相關文檔（README、使用指南等）

## 📁 專案結構規範

### 核心模組（不可隨意修改）
```
analysis_module/      # 技術分析模組
app_module/          # 應用層模組
backtest_module/     # 回測模組
data_module/         # 資料處理模組
decision_module/     # 決策引擎模組
```

### 資料目錄結構
```
data/
├── raw/              # 原始資料（不可修改）
├── daily_price/     # 每日價格資料（不可修改）
├── processed/       # 處理後的資料
├── technical_analysis/  # 技術指標資料
└── meta_data/       # 元資料
```

### 文檔目錄
```
docs/                # 專案文檔
├── agents/          # Agent 文檔（本目錄）
├── strategies/      # 策略文檔
└── [其他文檔]
```

## 🔧 技術棧與依賴

### 核心技術
- **Python 3.x**
- **PyQt5/PyQt6**（UI 框架）
- **pandas**（資料處理）
- **numpy**（數值計算）

### 資料格式
- **CSV**：主要資料格式（`stock_data_whole.csv` 等）
- **Parquet**：高效能資料儲存（可選）
- **JSON**：配置與元資料

## ⚠️ 禁止事項

### 絕對禁止
1. ❌ **刪除或修改原始資料檔案**
2. ❌ **破壞現有 API 的向後相容性**
3. ❌ **移除未經確認的依賴**（可能被其他模組使用）
4. ❌ **跳過測試直接合併代碼**
5. ❌ **修改核心模組結構而未更新文檔**

### 需要謹慎操作
1. ⚠️ **修改資料處理邏輯**（可能影響下游）
2. ⚠️ **重構核心模組**（需要完整測試）
3. ⚠️ **變更資料格式**（需要遷移腳本）
4. ⚠️ **移除功能**（需要確認使用情況）

## 📋 工作流程規範

### 開發流程
1. **閱讀相關文檔** → 了解現有架構
2. **檢查測試** → 確認現有測試狀態
3. **實現代碼** → 遵循編碼規範
4. **執行測試** → 確保所有測試通過
5. **更新文檔** → 同步更新相關文檔
6. **代碼審查** → 使用 tech_lead Agent 進行審查

### 資料處理流程
1. **驗證輸入資料** → 使用 data_audit_agent
2. **處理資料** → 非破壞性處理
3. **驗證輸出資料** → 確保資料完整性
4. **記錄變更** → 更新資料處理日誌

### 清理流程
1. **識別目標** → 使用 data_cleanup_agent 分析
2. **確認影響** → 檢查依賴關係
3. **備份重要資料** → 以防萬一
4. **執行清理** → 逐步進行
5. **驗證功能** → 確保無破壞性影響

## 📝 文件更新責任與規範

### 文件更新責任

**負責者：**
- **Documentation Agent**：負責識別需要更新的文件、產出更新內容（Coverage Pass + Patch Pass）
- **人類確認**：確認 Coverage 清單、審查更新內容、決定是否合併
- **Execution Agent**：執行代碼變更時，必須同步觸發 Documentation Agent 的 Coverage Pass

**責任流程：**
1. 代碼變更發生 → Execution Agent 或人類通知 Documentation Agent
2. Documentation Agent 執行 Coverage Pass → 列出需要更新的文件清單
3. 人類確認 Coverage 清單 → 授權更新範圍
4. Documentation Agent 執行 Patch Pass → 產出更新內容
5. 人類審查更新內容 → 確認後合併

### 必須更新文件的情況

以下情況發生時，**必須**更新對應文件：

1. **功能行為改變**
   - 功能新增、修改、移除
   - API 介面變更（參數、返回值、行為）
   - 使用者操作流程變更

2. **系統狀態改變**
   - Phase 完成狀態變更
   - 優先事項變更
   - 高風險區變更
   - 系統定位變更

3. **架構或流程改變**
   - 模組結構變更
   - 資料流程變更
   - 工作流程變更（「現在的工作模式」）

4. **文件結構改變**
   - 新增/刪除/重組文檔
   - 文檔索引結構變更

**更新範圍：**
- 根據 `docs/DOC_COVERAGE_MAP.md` 的「變更類型 → 必須更新的文件對照表」識別
- 所有標示為 Must 優先級的文件必須更新
- 必須執行 Snapshot / Index / Roadmap 一致性檢查

### 可以不更新文件的情況

以下情況發生時，**可以不更新**文件（但建議記錄在變更日誌）：

1. **純內部重構**
   - 代碼重構但不改變外部行為
   - 函數/類別重命名但不改變功能
   - 代碼風格調整

2. **不影響外部行為的變更**
   - 性能優化但不改變功能
   - Bug 修復但不改變 API
   - 測試覆蓋增加但不改變功能

3. **臨時性變更**
   - 實驗性功能（未正式發布）
   - 開發中的功能（未完成）

**判斷標準：**
- 使用者是否會感受到差異？
- API 是否改變？
- 操作流程是否改變？
- 如果答案都是「否」，則可以不更新文件

### 更新記錄 / 變更日誌規範

**位置：**
- **文件底部**：每個文件在底部維護「🔄 更新記錄」段落
- **集中式變更日誌**：重大變更記錄在 `docs/UPDATE_LOG_YYYY_MM_DD.md`（如存在）

**基本格式：**

**文件底部更新記錄格式：**
```markdown
## 🔄 更新記錄

- YYYY-MM-DD：[變更摘要]（影響範圍：XXX）
- YYYY-MM-DD：[變更摘要]（影響範圍：XXX）
```

**集中式變更日誌格式（如存在）：**
```markdown
## YYYY-MM-DD 變更記錄

### 變更摘要
[1-2 句話描述變更內容]

### 影響範圍
- 文件：[列出受影響的文件]
- 功能：[列出受影響的功能]
- 使用者：[說明對使用者的影響]

### 相關文件
- [文件路徑 1]：更新了 XXX 段落
- [文件路徑 2]：更新了 XXX 段落
```

**更新記錄責任：**
- **Documentation Agent**：在 Patch Pass 階段產出更新記錄內容
- **人類確認**：確認更新記錄準確性後合併

**更新記錄時機：**
- 所有 Must 優先級的文件更新時，必須更新記錄
- 重大變更（影響多個文件、影響使用者流程）時，建議記錄在集中式變更日誌

## 🔍 驗證檢查清單

在執行任何重要操作前，必須檢查：

- [ ] 是否影響現有功能？
- [ ] 是否有對應的測試？
- [ ] 是否更新了相關文檔？
- [ ] 是否破壞了向後相容性？
- [ ] 是否影響資料完整性？
- [ ] 是否遵循了專案結構規範？

## 📚 參考資源

- **專案文檔**：`docs/` 目錄
- **策略文檔**：`docs/strategies/`
- **開發路線圖**：`docs/DEVELOPMENT_ROADMAP.md`
- **系統架構**：`docs/system_architecture.md`

## 🔄 更新記錄

- 2026-01-03：初始建立共用上下文規範
- 2026-01-03：新增「文件更新責任與規範」段落（定義更新責任、必須/可以不更新情況、更新記錄格式）

