# Data Update Tab 問題盤點

## 1️⃣ 邏輯錯誤（Machine-checkable）

### 1.1 數據狀態檢查邏輯

**狀態**: ✅ 測試通過（17 項通過，0 項失敗）

**驗證結果**:
- `check_data_status()` 返回結構正確
- 所有必要欄位存在（`latest_date`, `total_records`, `status`）
- 日期格式正確（YYYY-MM-DD）
- 記錄數為非負整數

### 1.2 方法接口一致性

**狀態**: ✅ 測試通過

**驗證結果**:
- 所有 UI 調用的方法在 Service 中都存在
- 方法參數匹配
- 返回結構符合 UI 期望

---

## 2️⃣ 不一致的 DTO / 欄位命名

### 2.1 返回結構一致性

**狀態**: ✅ 一致

**驗證結果**:
- `check_data_status()` 返回結構與 UI 期望一致
- `update_daily()` 返回結構包含 `success`, `message`, `updated_dates`, `failed_dates`
- `merge_daily_data()` 返回結構包含 `success`, `message`, `total_records`, `merged_files`

---

## 3️⃣ 隱含假設

### 3.1 文件存在假設

**問題**: `check_data_status()` 假設數據文件存在
- **位置**: `app_module/update_service.py:218, 298, 322`
- **描述**: 如果文件不存在，會設置 `status: 'unknown'`，但不會拋出異常
- **影響**: 正常行為（文件不存在時返回 unknown 狀態）
- **狀態**: ✅ 正常

### 3.2 日期格式假設

**問題**: 假設日期欄位是 YYYYMMDD 格式或可解析格式
- **位置**: `app_module/update_service.py:275-284, 341-342`
- **描述**: 有多種日期格式處理邏輯
- **影響**: 如果日期格式不符合預期，可能無法正確解析
- **狀態**: ✅ 有處理邏輯（支持多種格式）

### 3.3 大文件處理假設

**問題**: 假設 `stock_data_whole.csv` 可能很大，使用高效讀取方式
- **位置**: `app_module/update_service.py:221-264`
- **描述**: 使用只讀日期欄位或跳過行數的方式來處理大文件
- **影響**: 如果文件格式不符合預期，可能讀取失敗
- **狀態**: ✅ 有錯誤處理（try-except）

---

## 4️⃣ 可能導致空結果 / NaN / 錯誤的情況

### 4.1 文件不存在

**情況**: 數據文件不存在
- **處理**: 返回 `status: 'unknown'`, `latest_date: None`, `total_records: 0`
- **狀態**: ✅ 正常處理

### 4.2 日期解析失敗

**情況**: 日期欄位無法解析
- **處理**: 使用字符串比較作為降級方案
- **狀態**: ✅ 有降級處理

### 4.3 文件讀取失敗

**情況**: CSV 文件格式錯誤或損壞
- **處理**: 使用 `on_bad_lines='skip'` 跳過錯誤行
- **狀態**: ✅ 有錯誤處理

---

## 5️⃣ UI 與 Service Contract 不一致

### 5.1 方法調用一致性

**狀態**: ✅ 一致

**驗證結果**:
- UI 調用的所有方法在 Service 中都存在
- 方法簽名匹配

### 5.2 返回結構一致性

**狀態**: ✅ 一致

**驗證結果**:
- UI 期望的返回欄位在 Service 返回中都存在
- 欄位類型匹配

---

## 6️⃣ 其他問題

### 6.1 性能問題

**問題**: `check_data_status()` 讀取大文件可能較慢
- **位置**: `app_module/update_service.py:234-264`
- **描述**: 對於非常大的文件（> 10000 行），使用跳過行的方式讀取
- **影響**: 可能仍然較慢
- **狀態**: ⚠️ 已優化但可能仍需改進

### 6.2 錯誤處理

**問題**: 部分錯誤可能被吞掉
- **位置**: `app_module/update_service.py:242-264`
- **描述**: 使用多層 try-except，可能掩蓋真實錯誤
- **影響**: 難以診斷問題
- **狀態**: ⚠️ 需要改進錯誤日誌

---

## 問題分類

### ✅ 可全自動驗證（QA script 可 cover）

- Service 層測試 ✅
- 方法接口驗證 ✅
- 返回結構驗證 ✅
- 數據狀態檢查邏輯 ✅
- 日期格式驗證 ✅
- 記錄數驗證 ✅

### ⚠️ 需啟動 Qt 但可自動化（pytest-qt / QTest）

- UI 組件初始化
- 按鈕點擊事件
- 進度條更新
- 日誌顯示
- Worker 任務執行

### 👀 必須人工檢查（純視覺/UX）

- UI 布局
- 按鈕樣式
- 進度條動畫
- 錯誤訊息顯示格式
- 確認對話框

---

## 📊 測試結果總結

### 測試摘要
- ✅ **通過**: 17 項
- ❌ **失敗**: 0 項
- ⏭️ **跳過**: 4 項（實際下載/合併測試，避免修改數據）

### 通過的測試
1. `check_data_status` 返回結構驗證
2. `check_data_status` 各數據類型結構驗證
3. `update_daily` 接口驗證
4. `update_market` 接口驗證
5. `update_industry` 接口驗證
6. `merge_daily_data` 接口驗證
7. UI ↔ Service Contract 驗證
8. 日期格式驗證
9. 記錄數驗證

### 跳過的測試
1. `update_daily` 實際執行（避免下載大量數據）
2. `update_market` 實際執行（避免下載大量數據）
3. `update_industry` 實際執行（避免下載大量數據）
4. `merge_daily_data` 實際執行（避免修改數據）

---

## 🎯 建議改進

### 優先級 1（可選）
1. **添加更詳細的錯誤日誌**
   - 在 `check_data_status()` 中添加 DEBUG 級別日誌
   - 記錄文件讀取過程中的詳細信息

2. **優化大文件讀取性能**
   - 考慮使用更高效的方式讀取最後幾行
   - 可以考慮使用 `tail` 命令（如果可用）

### 優先級 2（可選）
1. **添加進度回調**
   - 在 `update_daily()` 中添加進度回調
   - 讓 UI 可以顯示詳細進度

2. **改進錯誤訊息**
   - 提供更友好的錯誤訊息
   - 包含修復建議

---

## ✅ 結論

**數據更新 Tab 目前狀態良好**：
- ✅ 所有自動化測試通過
- ✅ 沒有發現邏輯錯誤
- ✅ UI 與 Service Contract 一致
- ✅ 數據狀態檢查邏輯正確

**如果用戶報告問題**，可能是：
1. 實際執行時的錯誤（需要查看 UI 日誌）
2. 文件權限問題
3. 網絡連接問題（下載時）
4. 數據格式問題（特定文件）

建議在 UI 中實際測試時，查看日誌輸出以診斷具體問題。

