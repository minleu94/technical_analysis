# Phase 3.3b 研究設計規格

**版本**：v1.0.0  
**狀態**：Research Design 完成  
**最後更新**：2025-01-XX

---

## 目標

完成真正的閉環：**推薦 → 回測 → 最佳化 → Promote 成策略版本 → 回到推薦**

讓回測成果可以「升級」為可用策略版本，並提供視覺驗證機制，為 Phase 4 持倉管理做準備。

---

## 1. 研究假設

### 假設 1：回測結果可升級為策略版本（Promote 機制）

**假設**：經過驗證的回測結果（包含參數、績效指標、適用 Regime）可以「升級」為正式的 `strategy_version`，並掛載到 Profile，讓推薦系統能夠使用這個經過實證的策略版本。

**驗證條件**：
- 回測結果必須通過 Walk-Forward 驗證（一致性 >= 60%，退化程度 < 40%）
- 回測結果必須優於 Baseline（Buy & Hold 或隨機策略）
- 回測結果必須有完整的參數記錄與績效摘要

### 假設 2：視覺驗證能提升策略合理性判斷（K 線標記）

**假設**：在 K 線圖上標記買賣點與理由，能夠幫助使用者快速驗證策略行為是否符合預期，識別異常信號（如買在高點、賣在低點），提升策略設計的合理性判斷。

**驗證條件**：
- 使用者能夠從 K 線圖上直觀看到策略的進出場時點
- 使用者能夠從標記中看到買賣理由（reason_tags）
- 視覺驗證能夠發現策略邏輯問題（如信號延遲、假突破）

### 假設 3：回測穩健性驗證能降低過擬合風險

**假設**：透過 Walk-Forward（含暖機期）、Baseline 對比、過擬合風險提示，能夠有效識別過擬合策略，確保策略在未來市場環境中仍能保持穩定表現。

**驗證條件**：
- Walk-Forward 測試期表現與訓練期表現差異 < 40%
- 策略表現優於 Buy & Hold 或隨機策略（統計顯著性 p < 0.05）
- 過擬合風險指標（如參數敏感性、退化程度）在可接受範圍內

---

## 2. 驗證目標

### 2.1 Promote 機制驗證目標

1. **功能完整性**：回測結果可以成功升級為 strategy_version，包含完整的參數、配置、績效摘要
2. **條件檢查正確性**：升級條件檢查（Walk-Forward、Baseline 對比）邏輯正確，能有效篩選出穩健策略
3. **Profile 整合**：升級後的策略版本可以掛載到 Profile，並在推薦系統中正常使用

### 2.2 視覺驗證驗證目標

1. **標記準確性**：K 線圖上的買賣點標記與實際交易信號一致
2. **理由顯示完整性**：hover tooltip 能正確顯示買賣理由（reason_tags）
3. **視覺效果**：標記清晰可見，不影響 K 線圖的閱讀

### 2.3 回測穩健性驗證目標

1. **Walk-Forward 可靠性**：暖機期處理正確，訓練期從暖機期後開始計算
2. **Baseline 對比準確性**：Baseline 策略計算正確，統計顯著性檢驗準確
3. **過擬合風險識別**：風險指標計算正確，風險提示等級合理

---

## 3. 驗證方法

### 3.1 Promote 機制驗證方法

1. **單元測試**：測試升級條件檢查邏輯（Walk-Forward 一致性、Baseline 對比）
2. **整合測試**：測試完整的升級流程（從回測結果到 strategy_version）
3. **端到端測試**：測試升級後的策略版本在推薦系統中的使用

### 3.2 視覺驗證驗證方法

1. **視覺檢查**：人工檢查 K 線圖上的買賣點標記是否正確
2. **功能測試**：測試 hover tooltip 是否能正確顯示理由標籤
3. **使用者測試**：讓使用者使用視覺驗證功能，收集反饋

### 3.3 回測穩健性驗證方法

1. **數值驗證**：使用已知數據驗證 Walk-Forward 和 Baseline 對比的計算結果
2. **統計驗證**：驗證統計顯著性檢驗的計算正確性
3. **邊界測試**：測試極端情況（如過短的測試期、過高的退化程度）

---

## 4. 風險與失效模式

### 4.1 Promote 機制風險

**風險點**：
1. **版本管理複雜**：需要管理 strategy_version 的版本號、依賴關係、回滾機制
2. **Profile 整合複雜**：需要處理 Profile 與 strategy_version 的關聯、版本衝突
3. **升級條件判斷**：需要定義明確的升級條件，避免過度寬鬆或嚴格

**失效模式**：
- 升級條件過於寬鬆，導致不穩健的策略被升級
- 升級條件過於嚴格，導致穩健的策略無法升級
- 版本管理混亂，導致策略版本衝突或遺失

**緩解措施**：
- 使用固定的升級條件（Walk-Forward 一致性 >= 60%，退化程度 < 40%）
- 簡化版本管理（使用簡單的版本號，不實作版本回滾機制）
- 提供 Fallback 方案（先實作「保存為 Preset」功能）

### 4.2 K 線圖標記風險

**風險點**：
1. **圖表庫選擇**：需要選擇合適的圖表庫（matplotlib、PyQtGraph、mplfinance）
2. **性能問題**：大量 K 線數據可能導致渲染緩慢
3. **互動體驗**：hover tooltip、縮放、平移等功能需要實作

**失效模式**：
- 圖表渲染緩慢，影響使用者體驗
- 標記不清晰，無法有效驗證策略行為
- 互動功能不完善，影響使用效率

**緩解措施**：
- 基於現有的 `EquityCurveWidget`，使用 `mplfinance` 繪製 K 線圖
- 限制顯示的 K 線數量（如最近 200 根）
- 先實作基本標記，後續再優化互動功能

### 4.3 Walk-Forward 暖機期風險

**風險點**：
1. **暖機期長度定義**：不同策略可能需要不同的暖機期長度
2. **數據可用性**：暖機期可能導致可用數據減少

**失效模式**：
- 暖機期過短，導致技術指標計算不準確
- 暖機期過長，導致可用數據過少，影響驗證可靠性

**緩解措施**：
- 使用固定的暖機期長度（20 個交易日）
- 後續再實作可調整的暖機期長度

### 4.4 過擬合風險提示風險

**風險點**：
1. **風險指標定義**：需要定義明確的風險指標閾值
2. **風險提示準確性**：風險提示可能過於保守或過於寬鬆

**失效模式**：
- 風險提示過於保守，導致穩健策略被誤判為高風險
- 風險提示過於寬鬆，導致過擬合策略未被識別

**緩解措施**：
- 使用固定的風險指標閾值（如參數敏感性 < 10%，退化程度 < 30%）
- 先做保守的風險提示（寧可多提示，不要漏掉）
- 根據實際使用情況調整風險指標閾值

---

## 5. 功能規格

### 5.1 Promote 機制（回測成果 → 可用策略版本）

#### 功能描述

讓回測結果可以「升級」為正式的 `strategy_version`，包含：
- 策略參數（從回測結果提取）
- 適用 Regime（從回測期間的 Regime 分布推斷）
- 回測摘要（績效指標、風險指標）
- 可掛載到 Profile（或變成新 Profile）

#### 資料結構

```python
@dataclass
class PromotedStrategyVersion:
    """升級後的策略版本"""
    strategy_id: str  # 原始策略 ID（如 "baseline_score_threshold"）
    strategy_version: str  # 新版本號（如 "1.1.0"，從回測結果生成）
    source_run_id: str  # 來源回測 run_id
    promoted_at: str  # 升級時間
    # 策略參數（從回測結果提取）
    params: Dict[str, Any]  # buy_score, sell_score, confirm_days 等
    config: Dict[str, Any]  # 完整策略配置（technical, patterns, signals）
    # 回測摘要
    backtest_summary: Dict[str, Any]  # total_return, sharpe_ratio, max_drawdown 等
    # 適用 Regime（從回測期間推斷）
    regime: List[str]  # ['Trend', 'Reversion', 'Breakout']
    # Profile 關聯
    profile_id: Optional[str]  # 掛載到哪個 Profile（可選）
    profile_version: Optional[str]  # Profile 版本（可選）
    # 驗證狀態
    validation_status: str  # 'pending', 'validated', 'rejected'
    validation_metrics: Dict[str, Any]  # Walk-Forward 結果、Baseline 對比結果
```

#### 升級條件（Promote Criteria）

1. **Walk-Forward 驗證通過**：
   - 一致性（Consistency）>= 60%
   - 平均退化程度（Average Degradation）< 40%
2. **Baseline 對比優於基準**：
   - 總報酬率 > Buy & Hold 總報酬率
   - Sharpe Ratio > Buy & Hold Sharpe Ratio（或 > 0.5）
3. **風險指標可接受**：
   - 最大回撤 < 30%（可調整）
   - 勝率 > 50%（可調整）

#### 升級流程

1. 使用者選擇回測結果（從 BacktestRunRepository）
2. 系統檢查升級條件（Walk-Forward、Baseline 對比）
3. 如果通過，生成新的 `strategy_version`
4. 可選擇掛載到現有 Profile 或創建新 Profile
5. 保存到 PresetService 或新的 StrategyVersionService

### 5.2 視覺驗證（K 線標記買賣點 v1）

#### 功能描述

在 K 線圖上標記買賣點，顯示買賣理由，作為策略合理性的視覺輔助（非交易建議）。

#### 視覺元素

- **買點標記**：綠色向上箭頭（^），標記在買入日期
- **賣點標記**：紅色向下箭頭（v），標記在賣出日期
- **理由標籤**：hover tooltip 顯示 reason_tags（如 "RSI超賣, 均線支撐"）
- **價格標記**：顯示買入/賣出價格

#### 技術實現

- 使用現有的 `EquityCurveWidget` 作為基礎（已有買賣點標記功能）
- 擴展為 K 線圖（Candlestick Chart）顯示
- 整合 `DailySignalFrame` 的 `reason_tags` 欄位

#### 顯示內容

- **K 線圖**：開高低收價格（Candlestick）
- **買賣點標記**：在對應日期標記
- **理由標籤**：hover 顯示（reason_tags）
- **技術指標疊加**（可選）：MA、RSI、MACD 等

### 5.3 回測穩健性驗證

#### 5.3.1 Walk-Forward（含暖機期）

##### 暖機期定義

- **目的**：確保技術指標計算有足夠歷史數據
- **長度**：建議 20-60 個交易日（約 1-3 個月）
- **處理方式**：訓練期從「開始日期 + 暖機期」開始計算

##### Walk-Forward 參數

- **訓練期長度**：6 個月（可調整）
- **測試期長度**：3 個月（可調整）
- **步進長度**：3 個月（建議與測試期相同）
- **暖機期長度**：20 個交易日（可調整）

##### 驗證指標

- **一致性（Consistency）**：測試期 Sharpe > 0 的比例
- **平均退化程度**：`(test_sharpe - train_sharpe) / |train_sharpe|`
- **穩定性評級**：根據退化程度分級（優秀/良好/可接受/需改進）

#### 5.3.2 Baseline 對比

##### 基準策略定義

1. **Buy & Hold（買入持有）**
   - 策略：期初買入，期末賣出
   - 用途：評估策略是否優於被動持有

2. **Random Entry（隨機進場）**
   - 策略：隨機選擇買入與賣出時點，保持相同交易頻率
   - 用途：評估信號是否有預測能力（vs 隨機）

3. **Simple Moving Average Crossover（簡單均線交叉）**
   - 策略：MA5 上穿 MA20 買入，下穿賣出
   - 用途：評估是否優於簡單技術指標

##### 對比指標

- **絕對績效**：總報酬率、年化報酬率、Sharpe Ratio、最大回撤
- **相對績效**：相對於 Buy & Hold 的超額報酬率
- **統計顯著性**：使用 t-test 檢驗超額報酬是否顯著（p < 0.05）

#### 5.3.3 過擬合風險提示

##### 風險指標

1. **參數敏感性**：參數小幅變動時，績效變化 < 10%
2. **退化程度**：測試期相對於訓練期的退化 < 30%
3. **交易次數**：過少（< 10 次）或過多（> 100 次）可能表示過擬合
4. **勝率異常**：勝率過高（> 80%）可能表示過擬合

##### 風險提示等級

- **低風險**：所有指標在可接受範圍內
- **中風險**：1-2 個指標超出範圍
- **高風險**：3 個以上指標超出範圍，建議重新設計策略

---

## 6. 驗收標準（Exit Criteria）

### Phase 3.3b 最小驗收標準

1. **視覺驗證**：
   - ✅ 使用者能夠從 K 線圖看到策略的進出場時點
   - ✅ 使用者能夠看到買賣理由（reason_tags）

2. **Baseline 對比**：
   - ✅ 回測報告包含 Buy & Hold 對比結果
   - ✅ 顯示相對績效（超額報酬率）

3. **Walk-Forward 暖機期**：
   - ✅ Walk-Forward 驗證包含暖機期處理
   - ✅ 訓練期從暖機期後開始計算

4. **Promote 機制（簡化版）**：
   - ✅ 回測結果可以保存為 Preset（使用現有的 PresetService）
   - ✅ 保存的 Preset 可以在推薦中使用

### Phase 3.3b 完整驗收標準（可選）

5. **過擬合風險提示**：
   - ✅ 回測報告包含過擬合風險提示
   - ✅ 風險提示等級明確（低/中/高）

6. **Promote 機制完整版**：
   - ✅ 回測結果可以升級為 strategy_version
   - ✅ 升級條件檢查正確（Walk-Forward、Baseline 對比）
   - ✅ 升級後的策略版本可以掛載到 Profile

---

**文檔版本**：v1.0.0  
**最後更新**：2025-01-XX  
**維護者**：量化研究團隊

