# 研究迭代 SOP（Iteration Playbook）

## 概述

本文檔定義了**固定、可重複的研究流程**，目標是在 10-15 分鐘內完成一次完整的研究循環並產出結論。

**核心原則**：
- 一次只允許改動一層（Universe / Regime / Score / Execution）
- 固定研究順序，避免跳步或同時改動多個層級
- 每一步都有明確的「可分析」標準和「退回調整」條件

---

## 研究層級架構

### 四層架構（由外到內）

```
Layer 1: Universe（選股清單）
    ↓
Layer 2: Regime（市場狀態）
    ↓
Layer 3: Score（評分閾值）
    ↓
Layer 4: Execution（執行參數）
```

**改動規則**：
- ✅ **允許**：一次只改動一層
- ❌ **禁止**：同時改動多層（例如：同時改 Universe 和 Score）

---

## 固定研究順序

### 步驟 1：推薦辨識力（Ranking Test）

**目標**：驗證推薦系統能否正確識別出「應該要買的股票」

**操作流程**：
1. 在「推薦分析」Tab 選擇 Profile 和參數
2. 執行推薦，獲得候選名單
3. 將名單加入 Watchlist（候選池）

**判斷指標**：
- **Primary**：
  - 推薦數量：10-50 檔（太少可能過濾太嚴，太多可能無效）
  - 推薦理由可讀性：每檔股票都有明確的「Why」和「Why Not」
- **Secondary**：
  - 產業分布：是否過度集中在單一產業
  - Regime 匹配度：推薦股票的 Regime 是否與當前市場狀態一致

**「可分析」標準**：
- ✅ 推薦數量在合理範圍內（10-50 檔）
- ✅ 每檔股票都有明確的推薦理由
- ✅ 至少 70% 的推薦股票 Regime 匹配

**「退回調整」條件**：
- ❌ 推薦數量 < 5 檔 → 調整 Score 層級（降低 buy_score）
- ❌ 推薦數量 > 100 檔 → 調整 Score 層級（提高 buy_score）
- ❌ 推薦理由模糊或缺失 → 檢查 Profile 配置（指標/圖形是否啟用）
- ❌ Regime 匹配度 < 50% → 檢查 Regime 檢測結果或調整 Regime 權重

**時間預估**：2-3 分鐘

---

### 步驟 2：回測行為合理性（Behavior）

**目標**：驗證策略在回測中的行為是否符合預期

**操作流程**：
1. 從「推薦分析」一鍵送回測（或手動配置）
2. 執行回測（單一股票或選股清單）
3. 查看 K 線圖標記的買賣點
4. 檢查交易明細

**判斷指標**：
- **Primary**：
  - 交易次數：10-100 次（太少可能信號不足，太多可能過度交易）
  - 平均持有天數：符合策略預期（短線 3-10 天，中線 10-30 天，長線 30+ 天）
  - 買賣點合理性：K 線圖上買賣點是否在合理位置（不買在高點、不賣在低點）
- **Secondary**：
  - 勝率：> 50% 為佳
  - 最大連續虧損次數：< 5 次為佳
  - 交易分布：是否集中在特定時期

**「可分析」標準**：
- ✅ 交易次數在合理範圍內（10-100 次）
- ✅ 平均持有天數符合策略類型
- ✅ K 線圖上買賣點位置合理（至少 70% 的買賣點在合理位置）
- ✅ 交易分布均勻（不集中在單一時期）

**「退回調整」條件**：
- ❌ 交易次數 < 5 次 → 調整 Score 層級（降低 buy_score 或 sell_score 閾值）
- ❌ 交易次數 > 200 次 → 調整 Score 層級（提高 buy_score 或 sell_score 閾值）或增加 cooldown_days
- ❌ 平均持有天數不符合策略類型 → 調整 Execution 層級（confirm_days、cooldown_days）
- ❌ 買賣點明顯不合理（> 30% 買在高點或賣在低點）→ 調整 Score 層級或檢查信號延遲
- ❌ 交易集中在單一時期 → 檢查數據完整性或調整 Universe 層級

**時間預估**：3-5 分鐘

---

### 步驟 3：穩健性（Train/Test、Walk-forward）

**目標**：驗證策略在不同時期、不同市場環境下的穩定性

**操作流程**：
1. 在「策略回測」Tab 展開「Walk-forward 驗證」區塊
2. 選擇驗證模式（Train-Test Split 或 Walk-forward）
3. 設定參數（訓練期/測試期長度、步進）
4. 執行驗證
5. 查看結果摘要

**判斷指標**：
- **Primary**：
  - Walk-Forward 一致性（Consistency）：>= 60% 為佳
  - 平均退化程度（Average Degradation）：< 40% 為佳
  - 過擬合風險等級：低風險為佳
- **Secondary**：
  - Baseline 對比：策略表現優於 Buy & Hold
  - 各 Fold 表現分布：標準差 < 0.3 為佳

**「可分析」標準**：
- ✅ Walk-Forward 一致性 >= 60%
- ✅ 平均退化程度 < 40%
- ✅ 過擬合風險等級為「低」或「中」
- ✅ 策略表現優於 Buy & Hold（至少總報酬率或 Sharpe Ratio 優於基準）

**「退回調整」條件**：
- ❌ 一致性 < 50% → 調整 Score 層級（參數可能過於敏感）或調整 Universe 層級（選股範圍可能不適合）
- ❌ 退化程度 >= 50% → 調整 Score 層級（可能過擬合）或調整 Execution 層級（執行參數可能不合理）
- ❌ 過擬合風險等級為「高」→ 必須退回調整，檢查參數是否過於貼合訓練數據
- ❌ 策略表現不如 Buy & Hold → 調整 Score 層級或 Execution 層級，或考慮更換策略

**時間預估**：5-7 分鐘

---

## 完整研究循環範例

### 場景：測試新的 buy_score 參數

**初始狀態**：
- Universe：已選定「本週強勢股 Top 20」
- Regime：Trend（趨勢市場）
- Score：buy_score = 60, sell_score = 40
- Execution：buy_confirm_days = 2, sell_confirm_days = 2, cooldown_days = 3

**研究目標**：測試 buy_score = 70 是否比 buy_score = 60 更好

**步驟 1：推薦辨識力**
- 改動：Score 層級（buy_score: 60 → 70）
- 執行推薦，獲得名單
- ✅ 檢查：推薦數量 15 檔，理由明確，Regime 匹配 80%
- **結論**：可進入下一步

**步驟 2：回測行為合理性**
- 一鍵送回測（使用 buy_score = 70 的配置）
- 執行回測
- ✅ 檢查：交易次數 45 次，平均持有 8 天，買賣點合理
- **結論**：行為合理，可進入下一步

**步驟 3：穩健性**
- 執行 Walk-forward 驗證
- ✅ 檢查：一致性 65%，退化程度 25%，過擬合風險「低」，優於 Buy & Hold
- **結論**：穩健性良好

**最終結論**：buy_score = 70 通過所有驗證，可以 Promote 為策略版本

---

## 常見問題與退回調整指南

### 問題 1：推薦數量太少（< 5 檔）

**可能原因**：
- Score 層級：buy_score 過高
- Universe 層級：選股範圍太窄

**調整建議**：
1. 先調整 Score 層級：降低 buy_score（例如：70 → 60）
2. 如果仍不足，調整 Universe 層級：擴大選股範圍

### 問題 2：交易次數太多（> 200 次）

**可能原因**：
- Score 層級：buy_score 或 sell_score 閾值過低
- Execution 層級：cooldown_days 太短

**調整建議**：
1. 先調整 Score 層級：提高 buy_score 或 sell_score
2. 如果仍過多，調整 Execution 層級：增加 cooldown_days

### 問題 3：Walk-Forward 一致性差（< 50%）

**可能原因**：
- Score 層級：參數過於敏感，在不同時期表現差異大
- Universe 層級：選股範圍不適合當前市場環境

**調整建議**：
1. 先調整 Score 層級：使用更保守的參數（提高 buy_score，降低 sell_score）
2. 如果仍不一致，調整 Universe 層級：縮小選股範圍或更換選股標準

### 問題 4：過擬合風險高

**可能原因**：
- Score 層級：參數過於貼合訓練數據
- 使用了參數最佳化但未進行 Walk-Forward 驗證

**調整建議**：
1. 必須退回調整，不能進入 Phase 4
2. 重新進行參數最佳化，但必須配合 Walk-Forward 驗證
3. 考慮使用更簡單的參數組合（減少參數數量）

---

## 時間分配建議

**總時間**：10-15 分鐘

- **步驟 1（推薦辨識力）**：2-3 分鐘
- **步驟 2（回測行為合理性）**：3-5 分鐘
- **步驟 3（穩健性）**：5-7 分鐘

**如果某一步超過預估時間**：
- 檢查是否同時改動了多個層級
- 檢查數據是否完整
- 考慮是否需要退回上一步重新調整

---

## 成功標準（Definition of Done）

完成一次研究循環後，必須能清楚回答：

1. **為什麼選這些股票？**
   - 基於哪個 Universe（選股清單）
   - 基於哪個 Regime（市場狀態）
   - 推薦理由是否明確

2. **為什麼這套參數合理 / 不合理？**
   - 回測行為是否符合預期
   - Walk-Forward 穩健性是否良好
   - 是否優於 Baseline

3. **問題出在哪一層？**
   - Universe / Regime / Score / Execution
   - 具體是哪個參數需要調整

4. **對是否進入 Phase 4 有明確判斷**
   - 參考「Phase 4 進入條件」文檔

---

**文檔版本**：v1.0  
**最後更新**：2026-01-02  
**適用階段**：Phase 3.5 (Readiness)

