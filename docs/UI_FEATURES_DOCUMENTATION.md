# UI 功能完整文檔

## 📊 當前開發階段

**Phase 3.3b 已完成 ✅**

系統已具備完整的研究閉環功能，包括：
- 跨 Tab 共用的 Watchlist
- 完整的市場觀察（強勢/弱勢股/產業）
- 可保存的推薦結果
- 增強的 Backtest 研究體驗
- 預設策略庫（暴衝/穩健策略）
- **研究閉環完整化**（Phase 3.3b 新增）：
  - ✅ 一鍵送回測（推薦 → 回測）
  - ✅ Walk-forward 暖機期與 Baseline 對比
  - ✅ 過擬合風險提示
  - ✅ Promote 機制（回測結果 → 策略版本）
  - ✅ K 線圖標記買賣點（視覺驗證）

**Phase 2.5 參數設計優化 ✅**
- ✅ 強勢/弱勢分數標準化（z-score 標準化）
- ✅ Pattern threshold/prominence ATR-based
- ✅ Scoring Contract 統一（所有子分數 0~100，Regime 用權重切換）
- ✅ 回測 execution_price 明確定義（next_open/close）
- ✅ 停損停利 ATR 倍數模式
- ✅ 部位管理（max_positions、reentry cooldown）

---

## 🖥️ UI Tab 架構

### Tab 1：數據更新 (UpdateView)

**功能：**
- 更新每日股票數據
- 更新大盤指數數據（✅ 已實現實際更新邏輯）
- 更新產業指數數據（✅ 已實現實際更新邏輯）
- 合併每日數據（✅ 已修復閃退問題）
- 檢查數據狀態

**操作：**
- 選擇日期範圍（查找範圍：最近 N 天，預設 10 天）
- 選擇更新類型（每日股票數據 / 大盤指數數據 / 產業指數數據）
- 點擊「開始更新」按鈕
- 查看更新進度和結果

**功能按鈕：**
- **開始更新**：根據查找範圍檢查缺失日期並下載數據（背景執行）
- **合併每日數據**：增量合併新數據到 `stock_data_whole.csv`
- **強制重新合併**：完全重建 `stock_data_whole.csv`（謹慎使用）
- **檢查數據狀態**：查看當前數據狀態（以三個獨立區塊顯示：每日股票數據、大盤指數、產業指數）

**UI 改進（最新）：**
- ✅ 數據狀態以三個並排區塊顯示（每日股票、大盤指數、產業指數），無需滾動
- ✅ 查找範圍預設改為 10 天（更符合日常使用）
- ✅ 說明文字字體更大（13px）、留白更少，提升可讀性
- ✅ 所有區域支持視窗縮放，自動調整大小

**技術改進（最新修復）：**
- ✅ Worker 線程管理改進（取消舊 Worker、等待完成、正確清理）
- ✅ 異常處理改進（所有異常都被正確捕獲和記錄）
- ✅ I/O 錯誤修復（`print()` → `logging`，避免標準輸出已關閉時崩潰）
- ✅ 實際更新邏輯實現（產業/大盤數據更新不再返回 stub）
- ✅ 合併數據功能修復（支持 config 參數，改進錯誤處理）

---

### Tab 2：市場觀察 (Market Watch)

包含 5 個子 Tab（順序：大盤指數 → 強勢個股 → 弱勢個股 → 強勢產業 → 弱勢產業）：

#### 2.1 大盤指數 (MarketRegimeView)

**功能：**
- 檢測並顯示當前市場狀態（Trend / Reversion / Breakout）
- 顯示市場信心度
- 提供三層資訊架構：結論層、摘要層、細節層

**市場狀態類型：**
- **Trend（趨勢追蹤）**：市場處於明確趨勢，顏色：深綠
- **Reversion（均值回歸）**：市場處於均值回歸狀態，顏色：橙
- **Breakout（突破準備）**：市場準備突破，顏色：藍

**三層資訊架構：**

1. **市場結論層（Layer 1）** - 左側 60%
   - 市場狀態名稱：24pt 粗體，使用分類色（唯一視覺錨點）
   - 信心度：緊貼市場狀態，作為修飾語（接近白色，確保清晰）
   - 簡短描述：不使用技術指標名詞的市場特性描述

2. **判斷摘要層（Layer 2）** - 右側 40%
   - 人類可讀的語句解釋判斷依據
   - 隱約對應指標，但不直接列出數值
   - 例如：「價格位於中長期均線之上 → 偏多結構」

3. **技術細節層（Layer 3）** - 可折疊
   - 預設收合，點擊 checkbox 展開
   - Checkbox 狀態：深綠底（已展開）、淺灰邊框（收合）
   - 標題動態顯示「技術細節（已展開）」或「技術細節（收合）」
   - 展開後並排顯示：
     - 價格與均線（收盤價、MA20、MA60、MA20斜率）
     - 趨勢指標（ADX、+DI、-DI、ATR 等）
     - 評分與貢獻（結構分、強度分、信心度等）
     - 其他指標（布林帶寬度、RSI，依市場狀態而定）
     - 判斷條件（所有 boolean 條件，使用 ✓/✗ 標記）

**策略建議：**
- 根據市場狀態自動顯示建議策略配置
- 包含技術指標、圖形模式、成交量條件等
- 使用 HTML 格式，標題高亮顯示

**操作：**
- 點擊「檢測市場狀態」按鈕更新市場狀態
- 點擊「技術細節」checkbox 展開/收合詳細資訊

**視覺設計：**
- 深色主題（#1e1e1e 背景）
- 文字使用淺色確保可讀性
- 市場狀態使用分類色，信心度使用中性色
- 留白優化，標題不貼邊但整體緊湊

---

#### 2.2 強勢個股 (StrongStocksView)

**功能：**
- 顯示強勢股票列表（按評分降序）
- 時間範圍選擇：本日 / 本周
- 加入觀察清單

**顯示欄位：**
- 排名
- 證券代號
- 證券名稱
- 收盤價
- 漲幅%
- 成交量變化率%
- 評分
- 推薦理由

**評分計算（Phase 2.5 改進）：**
```
1. 計算漲幅百分比和成交量變化率
2. 使用 z-score 標準化：
   - price_z = (漲幅% - mean) / std
   - vol_z = (成交量變化率% - mean) / std
3. 加權分數：
   評分 = price_z × 0.6 + vol_z × 0.4
```

**新增參數：**
- `volume_lookback`：量能均線用幾天（預設 20）
- `min_price`：過濾低價股（預設 5 元）
- `min_liquidity`：最小成交金額門檻（可選）

**參數：**
- `period`: 'day' 或 'week'
- `top_n`: 返回前 N 名（預設 50）
- `min_volume`: 最小成交量（可選）

---

---

#### 2.3 弱勢個股 (WeakStocksView)

**功能：**
- 顯示弱勢股票列表（按評分升序，最弱的在前）
- 時間範圍選擇：本日 / 本周
- 加入觀察清單

**顯示欄位：**（與強勢個股相同）

**評分計算：**（與強勢個股相同，但排序相反）

**參數：**（與強勢個股相同）

---

#### 2.4 強勢產業 (StrongIndustriesView)

**功能：**
- 顯示強勢產業列表（按漲幅%降序）
- 時間範圍選擇：本日 / 本周

**顯示欄位：**
- 排名
- 指數名稱
- 收盤指數
- 漲幅%

**參數：**
- `period`: 'day' 或 'week'
- `top_n`: 返回前 N 名（預設 50）

---

---

#### 2.5 弱勢產業 (WeakIndustriesView)

**功能：**
- 顯示弱勢產業列表（按漲幅%升序，最弱的在前）
- 時間範圍選擇：本日 / 本周

**顯示欄位：**（與強勢產業相同）

**參數：**（與強勢產業相同）

---

### Tab 3：推薦分析 (RecommendationView)

**功能：**
- 配置策略參數
- 執行推薦分析
- 顯示推薦結果
- 保存推薦結果
- 加入觀察清單
- **一鍵送回測**（Phase 3.3b 新增）：將推薦結果直接送到策略回測，自動載入股票清單和策略配置

#### 3.1 策略配置面板

**布局：**
- 左右分割比例：策略配置 20%，推薦結果 80%
- 所有區域支持視窗縮放

**技術指標配置（7個，全部在 UI 中可用）：**

##### 動量指標 (Momentum)
- **RSI（相對強弱指標）**
  - 參數：`period = 14`
  - 計算方式：使用 talib.RSI
  - 分數範圍：0-100

- **MACD（移動平均收斂發散）**
  - 參數：
    - `fastperiod = 12`
    - `slowperiod = 26`
    - `signalperiod = 9`
  - 計算方式：使用 talib.MACD
  - 輸出：MACD、Signal、Histogram

- **KD（隨機指標）**
  - 參數：
    - `fastk_period = 5`
    - `slowk_period = 3`
    - `slowd_period = 3`
  - 計算方式：使用 talib.STOCH
  - 分數範圍：0-100

##### 趨勢指標 (Trend)
- **ADX（平均趨向指標）**
  - 參數：`period = 14`
  - 計算方式：使用 talib.ADX
  - 分數範圍：0-100

- **MA（移動平均線）**
  - 參數：`windows = [5, 10, 20, 60]`
  - 計算方式：SMA（簡單移動平均）
  - 輸出：MA5、MA10、MA20、MA60

##### 波動率指標 (Volatility)
- **ATR（平均真實波幅）**
  - 參數：`period = 14`
  - 計算方式：使用 talib.ATR

- **Bollinger Bands（布林通道）**
  - 參數：
    - `timeperiod = 20`
    - `nbdevup = 2`
    - `nbdevdn = 2`
  - 計算方式：使用 talib.BBANDS
  - 輸出：上軌、中軌、下軌

#### 3.2 圖形模式配置

**可選圖形模式（12個，全部在 UI 中可用）：**

**看漲形態：**

##### W底（Phase 2.5 改進：ATR-based 參數）
- **描述**：兩個相近的低點，中間有一個高點，形成 W 形狀
- **看漲/看跌**：看漲（bullish = True）
- **參數：**
  - `min_points = 5`（至少需要 5 個點）
  - `max_points = 15`（最多考慮 15 個點）
  - `window = 10-30`（可調整）
  - `threshold = 0.03-0.1`（百分比模式，已棄用）
  - `threshold_atr_mult`（ATR 倍數模式，推薦使用，例如 0.5 = 0.5倍ATR）
  - `prominence = 0.3-1.0`（百分比模式，已棄用）
  - `prominence_atr_mult`（ATR 倍數模式，推薦使用，例如 1.0 = 1倍ATR）

##### 頭肩底
- **描述**：三個低點，中間的低點（頭）低於兩側的低點（肩）
- **看漲/看跌**：看漲（bullish = True）
- **參數：**
  - `min_points = 7`
  - `max_points = 20`
  - `window = 20-40`
  - `threshold = 0.05-0.15`
  - `height_ratio = 0.5-1.0`

##### 雙底
- **描述**：兩個相近的低點，形成 W 形狀
- **看漲/看跌**：看漲（bullish = True）
- **參數：**
  - `min_points = 5`
  - `max_points = 15`
  - `window = 10-30`
  - `threshold = 0.03-0.1`

##### V形反轉
- **描述**：價格快速下跌後立即快速上漲，形成V形
- **看漲/看跌**：看漲（bullish = True）
- **參數：**
  - `min_points = 3`
  - `max_points = 10`

##### 圓底
- **描述**：價格緩慢下跌後緩慢上漲，形成圓弧形底部
- **看漲/看跌**：看漲（bullish = True）
- **參數：**
  - `min_points = 7`
  - `max_points = 30`

**中性/可變形態：**

##### 矩形
- **描述**：價格在兩條平行的水平線之間波動
- **看漲/看跌**：取決於突破方向
- **參數：**
  - `min_points = 5`
  - `max_points = 30`
  - `window = 20-30`
  - `threshold = 0.05-0.08`

##### 三角形
- **描述**：價格波動範圍逐漸縮小，形成三角形
- **看漲/看跌**：可能是看漲或看跌，取決於三角形的類型
- **參數：**
  - `min_points = 5`
  - `max_points = 30`

##### 旗形
- **描述**：短期價格趨勢與主要趨勢相反，形成旗形
- **看漲/看跌**：可能是看漲或看跌，取決於旗形的類型
- **參數：**
  - `min_points = 5`
  - `max_points = 20`

##### 楔形
- **描述**：價格在兩條收斂的趨勢線之間波動，形成楔形
- **看漲/看跌**：可能是看漲或看跌，取決於楔形的類型
- **參數：**
  - `min_points = 5`
  - `max_points = 30`

**看跌形態（通常用於反向篩選）：**

##### 頭肩頂
- **描述**：三個高點，中間的高點（頭）高於兩側的高點（肩）
- **看漲/看跌**：看跌（bullish = False）
- **參數：**
  - `min_points = 7`
  - `max_points = 20`

##### 雙頂
- **描述**：兩個相近的高點，形成M形狀
- **看漲/看跌**：看跌（bullish = False）
- **參數：**
  - `min_points = 5`
  - `max_points = 15`

##### 圓頂
- **描述**：價格緩慢上漲後緩慢下跌，形成圓弧形頂部
- **看漲/看跌**：看跌（bullish = False）
- **參數：**
  - `min_points = 7`
  - `max_points = 30`

#### 3.3 篩選條件

- **最小漲幅%**：預設 0.0
- **最小成交量比率**：預設 1.0
- **產業篩選**：可選擇特定產業或「全部」

#### 3.4 推薦結果

**布局：**
- 上下分割比例：推薦結果表格 70%，推薦理由詳情 30%
- 支持拖動分割器調整比例

**顯示欄位：**
- 證券代號
- 證券名稱
- 收盤價
- 漲幅%
- 總分
- 指標分
- 圖形分
- 成交量分
- 推薦理由
- 產業
- Regime匹配

**推薦理由詳情功能：**
- **單擊或雙擊**表格中的任意股票行
- 下方的「推薦理由詳情」區域會自動顯示該股票的詳細推薦理由
- 推薦理由包含：技術指標分數、圖形模式識別、成交量條件、市場狀態匹配等

**分數計算（Phase 2.5 改進）：**
```
每個子分數統一為 0~100：
- IndicatorScore: 0~100
- PatternScore: 0~100
- VolumeScore: 0~100

總分 = 指標分 × 權重 + 圖形分 × 權重 + 成交量分 × 權重

Regime 權重切換（不再使用倍率）：
- Trend: w_indicator=0.6, w_pattern=0.2, w_volume=0.2
- Reversion: w_indicator=0.5, w_pattern=0.3, w_volume=0.2
- Breakout: w_indicator=0.4, w_pattern=0.4, w_volume=0.2
```

#### 3.5 一鍵送回測（Phase 3.3b 新增）

**功能：**
- 將推薦結果直接送到策略回測 Tab
- 自動載入股票清單、策略參數與 ATR 風控設定
- 根據 Profile 風險等級自動設置執行價格（暴衝用 next_open，穩健用 close）

**使用方法：**
1. 執行推薦分析後，在推薦結果表格中選擇要回測的股票
2. 點擊「送往回測」按鈕
3. 系統會自動切換到「策略回測」Tab
4. 回測配置會自動載入：
   - 股票清單：選中的推薦股票
   - 策略參數：當前使用的 Profile 配置
   - 執行價格：根據 Profile 風險等級自動設置
   - ATR 風控：根據 Profile 自動設置

**注意事項：**
- 一鍵送回測會保留推薦時的 Profile 配置和 Regime 快照
- 可以在回測 Tab 中進一步調整參數後執行回測

---

### Tab 4：策略回測 (BacktestView)

**功能：**
- 單檔回測：對單一股票執行回測
- 批次回測：對多檔股票（選股清單）執行回測
- 策略預設管理：儲存/載入/刪除策略配置
- 參數最佳化（Grid Search）：掃描參數範圍，找出最佳參數組合
- Walk-forward 驗證：時間序列交叉驗證，評估策略穩定性
- 回測結果保存與載入：SQLite + Parquet/CSV 格式
- 回測歷史管理：比較不同回測結果、刪除歷史記錄
- 圖表視覺化：權益曲線、回撤曲線、報酬分佈、持有天數

#### 4.1 基本回測設定

**股票選擇模式：**
- **單一股票模式**：輸入單一股票代號（例如：2330）
- **選股清單模式**：從觀察清單或選股清單中選擇

**選股清單來源：**
- 跨 Tab 共用的觀察清單（WatchlistService）
- Backtest 專用的選股清單（UniverseService）

**其他參數（Phase 2.5 改進）：**
- 開始日期（日期選擇器）
- 結束日期（日期選擇器）
- 初始資金（預設 1,000,000，範圍 10,000 - 100,000,000）
- 手續費（預設 14.25 bps，可設為 0 進行敏感度分析）
- 滑價（預設 5.0 bps，可設為 0 進行敏感度分析）

**執行價格（Phase 2.5 新增）：**
- 下拉選單選擇
- **next_open**（下一根K開盤，預設，避免偷看）
- **close**（當根K收盤）

**停損停利模式（Phase 2.5 新增）：**
- 下拉選單選擇模式
- **百分比模式**（預設顯示）：
  - 停損：百分比輸入框（0-50%，0 = 關閉）
  - 停利：百分比輸入框（0-100%，0 = 關閉）
- **ATR 倍數模式**（推薦，切換後顯示）：
  - 停損：ATR 倍數輸入框（0-10，0 = 關閉）
  - 停利：ATR 倍數輸入框（0-20，0 = 關閉）
  - **優先級**：ATR 模式優先於百分比模式

**部位管理（Phase 2.5 新增，獨立 GroupBox）：**
- **最大持有部位數**：整數輸入框（1-50，0 = 無限制，預設：1）
- **部位加權方式**：下拉選單
  - 等權重（預設）
  - 分數加權
  - 波動調整
- **允許加碼**：複選框（預設：關閉）
  - 啟用後允許金字塔式建倉
- **允許重新進場**：複選框（預設：開啟）
  - 關閉時禁用冷卻天數輸入框
- **重新進場冷卻天數**：整數輸入框（0-30 天，預設：5 天）
  - 僅在「允許重新進場」開啟時啟用

#### 4.2 策略預設管理

**功能：**
- 儲存當前策略配置為預設
- 載入已儲存的預設
- 刪除預設

**操作：**
1. 選擇策略並設定參數
2. 點擊「儲存」按鈕，輸入預設名稱
3. 下次可直接從下拉選單載入預設

**數據持久化：**
- JSON 格式儲存
- 路徑：`output/backtest/presets/`

#### 4.3 策略選擇與參數

**可用策略：**

##### baseline_score_threshold（基準策略）
- **名稱**：Baseline Score Threshold
- **描述**：總分閾值策略（帶 cooldown 防護），用於回歸測試
- **適用 Regime**：全部
- **風險等級**：medium
- **參數：**
  - `buy_score`：買入閾值（預設 60）
  - `sell_score`：賣出閾值（預設 40）
  - `buy_confirm_days`：買入確認天數（預設 2）
  - `sell_confirm_days`：賣出確認天數（預設 2）
  - `cooldown_days`：交易後冷卻天數（預設 3）

##### momentum_aggressive_v1（暴衝策略）
- **名稱**：暴衝策略
- **描述**：在強勢趨勢市場中追隨動能，追求快速獲利。適合風險承受度高的投資者。
- **適用 Regime**：Trend, Breakout
- **不適用 Regime**：Reversion
- **風險等級**：high
- **參數：**
  - `buy_score`：買入閾值（預設 70，較高）
  - `sell_score`：賣出閾值（預設 50，快速止盈）
  - `buy_confirm_days`：買入確認天數（預設 1，快速進場）
  - `sell_confirm_days`：賣出確認天數（預設 1，快速出場）
  - `cooldown_days`：交易後冷卻天數（預設 2，較短）

##### stable_conservative_v1（穩健策略）
- **名稱**：穩健策略
- **描述**：在均值回歸市場中尋找被低估的機會，追求穩定報酬。適合風險承受度低的投資者。
- **適用 Regime**：Reversion
- **不適用 Regime**：Trend, Breakout
- **風險等級**：low
- **參數：**
  - `buy_score`：買入閾值（預設 55，較低，尋找被低估）
  - `sell_score`：賣出閾值（預設 45，穩定獲利）
  - `buy_confirm_days`：買入確認天數（預設 3，較長，避免假信號）
  - `sell_confirm_days`：賣出確認天數（預設 3，較長）
  - `cooldown_days`：交易後冷卻天數（預設 5，較長，避免頻繁交易）

#### 4.4 批次回測

**功能：**
- 對選股清單中的所有股票執行回測
- 顯示批次回測進度
- 匯總統計結果（平均報酬率、勝率等）
- 個別股票結果可查看詳情

**操作：**
1. 選擇「選股清單」模式
2. 從下拉選單選擇清單
3. 設定回測參數
4. 點擊「執行批次回測」

#### 4.5 參數最佳化（Grid Search）

**功能：**
- 掃描參數範圍，找出最佳參數組合
- 顯示進度（完成 x/y 組參數）
- 顯示最佳化結果表格（按目標指標排序）
- 雙擊表格行可套用參數到表單

**參數設定：**
- 每個參數可設定為「固定值」或「範圍」
- 範圍參數：最小值、最大值、步長
- 目標指標：夏普比率 / 年化報酬率 / CAGR-MDD權衡

**使用流程：**
1. 選擇策略
2. 在「參數最佳化」Tab 中設定要掃描的參數範圍
3. 選擇目標指標（夏普比率/年化報酬率/CAGR-MDD權衡）
4. 點擊「執行最佳化」
5. 等待掃描完成（顯示進度）
6. 查看結果表格，雙擊最佳參數組合套用

#### 4.6 Walk-forward 驗證（Phase 3.3b 增強）

**功能：**
- 時間序列交叉驗證，評估策略在不同時期的穩定性
- Train-Test Split：將數據分為訓練集和測試集
- Rolling Window：滾動窗口驗證
- **暖機期處理**（Phase 3.3b 新增）：確保技術指標計算有足夠歷史數據

**參數：**
- 訓練期長度（預設 6 個月）
- 測試期長度（預設 3 個月）
- 步長（預設 3 個月）
- **暖機期天數**（Phase 3.3b 新增，預設 0，向後兼容）
  - 訓練期從「開始日期 + 暖機期」開始計算
  - 確保技術指標有足夠歷史數據進行計算
  - 建議值：20-60 個交易日（約 1-3 個月）

**Walk-forward 結果包含：**
- 訓練期績效指標
- 測試期績效指標
- 退化程度（Degradation）：測試期相對於訓練期的表現退化
- 一致性指標（Consistency）：多個 Fold 之間表現的一致性
- 暖機期資訊（Phase 3.3b 新增）

#### 4.7 回測結果（Phase 3.3b 增強）

**顯示指標：**
- 總報酬率
- 年化報酬率
- 夏普比率
- 最大回撤
- 勝率
- 總交易次數
- 期望值

**Baseline 對比**（Phase 3.3b 新增）：
- **Buy & Hold 對比**：策略表現相對於 Buy & Hold 基準
  - Baseline 總報酬率
  - 策略總報酬率
  - 超額報酬率（Excess Return）
  - 相對 Sharpe 比率
  - 統計顯著性（p-value）

**過擬合風險提示**（Phase 3.3b 新增）：
- **風險等級**：低 / 中 / 高
- **風險分數**：0.0 - 10.0
- **風險指標**：
  - Walk-Forward 退化程度（Degradation）
  - 一致性標準差（Consistency）
  - 參數敏感性（Parameter Sensitivity，需要最佳化結果）
- **警告訊息**：風險說明與改善建議
- **注意**：需要提供 Walk-Forward 結果才能計算過擬合風險

**圖表：**
- 權益曲線
- 回撤曲線
- 報酬分佈
- 持有天數
- **K 線圖標記買賣點**（Phase 3.3b 新增）
  - 使用 mplfinance 繪製 K 線圖
  - 綠色向上箭頭標記買入點
  - 紅色向下箭頭標記賣出點
  - 顯示買賣理由標籤（reason_tags）

#### 4.8 Promote 機制（Phase 3.3b 新增）

**功能：**
- 將回測結果升級為策略版本
- 升級條件檢查（Walk-Forward、Baseline 對比、風險指標）
- 策略版本管理與 Profile 整合

**升級條件：**
1. **Walk-Forward 驗證通過**：
   - 一致性（Consistency）>= 60%
   - 平均退化程度（Average Degradation）< 40%
2. **Baseline 對比優於基準**：
   - 總報酬率 > Buy & Hold 總報酬率
   - Sharpe Ratio > Buy & Hold Sharpe Ratio（或 > 0.5）
3. **風險指標可接受**：
   - 最大回撤 < 30%（可調整）
   - 勝率 > 50%（可調整）

**使用方法：**
1. 執行回測並查看結果
2. 點擊「Promote」按鈕
3. 系統會自動檢查升級條件
4. 如果通過，輸入版本名稱和備註（可選）
5. 確認後，回測結果會升級為策略版本
6. 升級後的策略版本可以在推薦分析中使用

**注意事項：**
- 只有通過升級條件的回測結果才能 Promote
- Promote 後的策略版本會保存完整的參數、配置和回測摘要
- 可以在推薦分析中選擇已 Promote 的策略版本作為參數預設

---

### Tab 5：觀察清單管理器 (WatchlistView)

**功能定位：**
- 跨 Tab 共用的股票觀察清單管理
- 選股清單管理（用於策略回測）
- 觀察清單與選股清單之間的轉換

**UI 布局（最新改進）：**
- **上方主要工作區（70% 高度）**：觀察清單表格
  - 顯示當前觀察清單中的所有股票
  - 支持排序、多選、右鍵選單
  - 統計信息顯示（共 X 檔股票）
- **下方管理操作區（30% 高度）**：
  - **左側**：觀察清單操作按鈕（垂直排列）
    - 刷新、新增股票、移除選中、清空清單
    - 保存為選股清單
  - **右側**：選股清單管理（用於回測）
    - 選股清單列表
    - 載入到觀察清單
    - 新增/編輯/刪除選股清單

**布局特性：**
- 使用垂直 `QSplitter` 分割主要工作區和管理區（可拖曳調整）
- 使用水平 `QSplitter` 分割左右操作區（可拖曳調整）
- 預設比例：上方 70%，下方 30%
- 主要工作區在上方，符合「主資訊在上、輔助操作在下」的視覺結構

**顯示欄位：**
- 證券代號
- 證券名稱
- 加入時間
- 來源
- 備註

**觀察清單操作：**
- **新增股票**：手動輸入股票代號和名稱
- **移除選中**：移除選中的股票
- **清空清單**：清空整個觀察清單
- **保存為選股清單**：將當前觀察清單保存為選股清單，用於策略回測

**選股清單管理：**
- **載入到觀察清單**：從選中的選股清單載入股票到觀察清單（已存在的股票不會重複加入）
- **新增**：創建新的選股清單（輸入名稱和股票代號列表）
- **編輯**：編輯現有選股清單（修改名稱和股票代號）
- **刪除**：刪除選股清單

**數據持久化：**
- 觀察清單：JSON 格式儲存，路徑：`output/watchlist/default.json`
- 選股清單：JSON 格式儲存，路徑：`output/backtest/watchlists/`

---

## 📈 技術指標詳細參數

### 動量指標

#### RSI（相對強弱指標）
```python
period = 14  # 計算週期
計算方式：talib.RSI(close, timeperiod=14)
分數範圍：0-100
```

#### MACD（移動平均收斂發散）
```python
fastperiod = 12    # 快速 EMA 週期
slowperiod = 26    # 慢速 EMA 週期
signalperiod = 9   # 信號線週期
計算方式：talib.MACD(close, fastperiod=12, slowperiod=26, signalperiod=9)
輸出：MACD、MACD_signal、MACD_hist
```

#### KD（隨機指標）
```python
fastk_period = 5   # 快速 K 週期
slowk_period = 3   # 慢速 K 週期
slowd_period = 3   # D 週期
計算方式：talib.STOCH(high, low, close, fastk_period=5, slowk_period=3, slowd_period=3)
分數範圍：0-100
```

### 趨勢指標

#### ADX（平均趨向指標）
```python
period = 14  # 計算週期
計算方式：talib.ADX(high, low, close, timeperiod=14)
分數範圍：0-100
```

#### MA（移動平均線）
```python
windows = [5, 10, 20, 60]  # 移動平均週期
計算方式：talib.SMA(close, timeperiod=window)
輸出：MA5、MA10、MA20、MA60
```

### 波動率指標

#### ATR（平均真實波幅）
```python
period = 14  # 計算週期
計算方式：talib.ATR(high, low, close, timeperiod=14)
```

#### Bollinger Bands（布林通道）
```python
timeperiod = 20  # 移動平均週期
nbdevup = 2     # 上軌標準差倍數
nbdevdn = 2     # 下軌標準差倍數
計算方式：talib.BBANDS(close, timeperiod=20, nbdevup=2, nbdevdn=2)
輸出：上軌、中軌、下軌
```

---

## 🎯 圖形模式詳細參數

### W底（Phase 2.5 改進：ATR-based 參數）
```python
描述：兩個相近的低點，中間有一個高點，形成 W 形狀
看漲/看跌：看漲（bullish = True）
min_points = 5      # 至少需要 5 個點
max_points = 15    # 最多考慮 15 個點
window = 10-30     # 窗口大小（可調整）

# 舊參數（百分比模式，已棄用，保留向後兼容）
threshold = 0.03-0.1  # 閾值（相對於價格範圍）
prominence = 0.3-1.0  # 突出度（相對於價格範圍）

# 新參數（ATR 倍數模式，推薦使用）
threshold_atr_mult = 0.5  # 兩個低點差異閾值（ATR 倍數）
prominence_atr_mult = 1.0  # 峰值突出度（ATR 倍數）
```

### 頭肩底
```python
描述：三個低點，中間的低點（頭）低於兩側的低點（肩）
看漲/看跌：看漲（bullish = True）
min_points = 7
max_points = 20
window = 20-40
threshold = 0.05-0.15
height_ratio = 0.5-1.0
```

### 雙底
```python
描述：兩個相近的低點，形成 W 形狀
看漲/看跌：看漲（bullish = True）
min_points = 5
max_points = 15
window = 10-30
threshold = 0.03-0.1
```

### 矩形
```python
描述：價格在兩條平行的水平線之間波動
看漲/看跌：取決於突破方向
min_points = 5
max_points = 30
window = 20-30
threshold = 0.05-0.08
```

---

## 🔧 系統配置

### 數據路徑
- 股票數據：`data/daily_price/`
- 技術指標：`data/technical_analysis/`
- 大盤指數：`data/meta_data/market_index.csv`
- 產業指數：`data/meta_data/industry_index.csv`

### 輸出路徑
- 回測結果：`output/backtest/`
- 推薦結果：`output/recommendation/`
- 觀察清單：`output/watchlist/`

---

## 📝 備註

1. **技術指標計算**：使用 TA-Lib 庫進行計算
2. **圖形模式識別**：使用 scipy 的 peak detection 和 curve fitting
3. **評分系統**：統一打分引擎（ScoringEngine）整合所有指標
4. **Regime 匹配**：根據市場狀態調整評分權重
5. **數據持久化**：使用 JSON（觀察清單、推薦結果）和 SQLite（回測結果）

---

**最後更新：Phase 3.3b 完成後（2026-01-02）**

## 🔧 最新修復記錄

### 推薦分析 Tab 修復
- ✅ 修復類型轉換錯誤（價格/成交量數據）
- ✅ 修復缺失方法（`_get_regime_weights`）
- ✅ 修復日期解析問題
- ✅ 修復 `FutureWarning`（Pandas API 更新）

### 數據更新 Tab 修復
- ✅ 修復合併數據閃退問題（Worker 線程管理）
- ✅ 修復產業/大盤數據更新（實現實際更新邏輯）
- ✅ 修復 I/O 錯誤（標準輸出已關閉問題）
- ✅ 改進錯誤處理和日誌記錄
- ✅ QA 驗證通過（17/17 測試通過）

詳細修復記錄請參考：
- [推薦分析 Tab QA 報告](../output/qa/recommendation_tab/VALIDATION_REPORT.md)
- [數據更新 Tab QA 報告](../output/qa/update_tab/VALIDATION_REPORT.md)

## 📚 相關文檔

- [參數設計改進計劃](docs/PARAMETER_DESIGN_IMPROVEMENTS.md) - Phase 2.5 參數優化詳細說明
- [使用者指南](docs/USER_GUIDE.md) - 功能使用教程
- [開發演進地圖](docs/DEVELOPMENT_ROADMAP.md) - 完整開發計劃

