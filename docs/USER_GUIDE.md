# 使用者指南

## 📋 目錄

1. [推薦分析 - 產業篩選](#推薦分析---產業篩選)
2. [推薦分析 - 推薦理由詳情](#推薦分析---推薦理由詳情)
3. [推薦分析 - 技術指標與圖形模式](#推薦分析---技術指標與圖形模式)
4. [推薦分析 - 新手/進階模式切換](#推薦分析---新手進階模式切換)
5. [推薦分析 - Profiles 策略風格](#推薦分析---profiles-策略風格)
6. [推薦分析 - Explain 面板（分數拆解）](#推薦分析---explain-面板分數拆解)
7. [推薦分析 - 一鍵送回測](#推薦分析---一鍵送回測)
8. [策略回測 - 參數最佳化](#策略回測---參數最佳化)
9. [策略回測 - Walk-forward 驗證](#策略回測---walk-forward-驗證)

---

## 推薦分析 - 產業篩選

### 問題
產業下拉選單只顯示「全部」，其他產業選項不見了。

### 解決方案
已修復：系統會自動從 `IndustryMapper` 載入所有產業類別。

### 使用方法
1. 打開「推薦分析」Tab
2. 在「篩選條件」區塊中找到「產業」下拉選單
3. 點擊下拉選單，應該會看到：
   - 「全部」（預設，不篩選產業）
   - 所有可用的產業類別（按字母順序排列）

### 注意事項
- 如果產業列表為空，請檢查 `data/meta_data/companies.csv` 是否正確載入
- 產業類別來自 `companies.csv` 的 `industry_category` 欄位

---

## 推薦分析 - 推薦理由詳情

### 功能說明
推薦理由詳情功能可以查看每檔推薦股票的詳細推薦理由，幫助理解為什麼這檔股票被推薦。

### 使用方法
1. 執行推薦分析後，推薦結果會顯示在右側表格中
2. **單擊**或**雙擊表格中的任意股票行**
3. 下方的「推薦理由詳情」區域會自動顯示該股票的詳細推薦理由

### 推薦理由內容
推薦理由通常包含：
- 技術指標分數（例如：RSI超買、MACD金叉）
- 圖形模式識別（例如：W底、頭肩底）
- 成交量條件（例如：成交量放大）
- 市場狀態匹配（例如：市場狀態為【突破準備】）

### 注意事項
- 如果沒有選擇股票，推薦理由詳情區域會顯示空白
- 推薦理由詳情區域可以通過拖動分割器調整大小
- 預設比例：推薦結果表格 70%，推薦理由詳情 30%

---

## 推薦分析 - 技術指標與圖形模式

### 技術指標（7個）

#### 動量指標
- **RSI**：相對強弱指數，用於判斷超買超賣
- **MACD**：移動平均收斂發散指標，用於判斷趨勢轉換
- **KD**：隨機指標，用於判斷買賣時機

#### 趨勢指標
- **移動平均線**：多條均線系統（MA5、MA10、MA20、MA60）
- **ADX**：平均趨向指標，用於判斷趨勢強度

#### 波動率指標
- **布林通道**：用於判斷價格波動範圍
- **ATR**：平均真實波幅，用於判斷波動度

### 圖形模式（12個）

#### 看漲形態
- **W底**：兩個相近的低點，中間有一個高點
- **頭肩底**：三個低點，中間的低點（頭）低於兩側的低點（肩）
- **雙底**：兩個相近的低點，形成W形狀
- **V形反轉**：價格快速下跌後立即快速上漲
- **圓底**：價格緩慢下跌後緩慢上漲，形成圓弧形底部

#### 中性/可變形態
- **矩形**：價格在兩條平行的水平線之間波動
- **三角形**：價格波動範圍逐漸縮小
- **旗形**：短期價格趨勢與主要趨勢相反
- **楔形**：價格在兩條收斂的趨勢線之間波動

#### 看跌形態（通常用於反向篩選）
- **頭肩頂**：三個高點，中間的高點（頭）高於兩側的高點（肩）
- **雙頂**：兩個相近的高點，形成M形狀
- **圓頂**：價格緩慢上漲後緩慢下跌，形成圓弧形頂部

### 使用建議
- **初學者**：建議先使用預設選項（RSI、MACD、移動平均線、ADX、W底、頭肩底、雙底、矩形）
- **進階使用者**：可以根據市場狀態和策略需求，選擇更多技術指標和圖形模式
- **注意**：選擇過多指標和模式可能會導致推薦結果過少或過多，建議根據實際需求調整

---

## 推薦分析 - 新手/進階模式切換

### 功能說明
推薦分析提供兩種模式，讓不同經驗層級的使用者都能輕鬆使用：
- **新手模式**：簡化操作，只顯示關鍵配置選項
- **進階模式**：完整配置面板，可精細調整所有參數

### 使用方法

#### 切換模式
1. 打開「推薦分析」Tab
2. 在「策略配置」面板右上角找到「切換至進階模式」或「切換至新手模式」按鈕
3. 點擊按鈕即可切換模式

#### 新手模式
**顯示內容：**
- 市場狀態顯示
- 策略建議（根據市場狀態自動建議 Profile）
- Profile 選擇下拉選單
- Profile 說明（包含風險提示）
- 執行推薦分析按鈕

**隱藏內容：**
- 技術指標詳細配置
- 圖形模式詳細配置
- 篩選條件詳細配置
- 策略傾向提示

**適用對象：**
- 剛開始使用系統的使用者
- 不想手動調整參數的使用者
- 希望快速產出推薦名單的使用者

#### 進階模式
**顯示內容：**
- 所有配置選項（技術指標、圖形模式、篩選條件等）
- 策略傾向提示
- 完整的參數調整能力

**隱藏內容：**
- Profile 選擇（但仍可使用策略建議）

**適用對象：**
- 熟悉技術分析的使用者
- 需要精細調整策略參數的使用者
- 想要自訂策略配置的使用者

### 使用建議
- **新手**：建議先使用新手模式，熟悉系統後再切換到進階模式
- **進階使用者**：可以直接使用進階模式，獲得完整的控制權
- **模式切換**：可以隨時切換模式，不會影響已執行的推薦結果

---

## 推薦分析 - Profiles 策略風格

### 功能說明
Profiles 是預設的策略風格配置，讓使用者可以快速選擇適合的投資風格，無需手動調整複雜的參數。

### 三種 Profiles

#### 1. 暴衝策略（Momentum）
**適用市場狀態：** 趨勢追蹤、突破準備  
**風險等級：** 高  
**特點：**
- 尋找價格快速上漲且成交量明顯放大的股票
- 預期最大回撤：15-30%
- 建議持有期間：1-5 天
- 適合：願意承擔高風險、追求快速獲利的交易者

**配置特點：**
- 技術指標：RSI、MACD、ADX、移動平均線、ATR
- 圖形模式：旗形、三角形、矩形、V形反轉
- 篩選條件：漲幅 >= 2.0%，成交量變化率 >= 50%

#### 2. 穩健策略（Stable）
**適用市場狀態：** 均值回歸  
**風險等級：** 低  
**特點：**
- 在均值回歸市場中尋找被低估的機會
- 預期最大回撤：5-10%
- 建議持有期間：5-20 天
- 適合：風險承受度低、偏好穩定報酬的投資者

**配置特點：**
- 技術指標：RSI、MACD、KD、ADX、移動平均線、布林通道、ATR
- 圖形模式：W底、頭肩底、雙底、圓底、矩形
- 篩選條件：漲幅 -5% ~ 5%，成交量變化率 >= 0%，RSI <= 50

#### 3. 長期策略（Long-term）
**適用市場狀態：** 趨勢追蹤、突破準備  
**風險等級：** 中  
**特點：**
- 基於長期趨勢和基本面，尋找具有持續成長潛力的股票
- 預期最大回撤：10-20%
- 建議持有期間：20-60 天
- 適合：長期持有、追求穩定成長的投資者

**配置特點：**
- 技術指標：MACD、ADX、移動平均線（包含 120 日均線）、ATR
- 圖形模式：圓底、矩形、三角形
- 篩選條件：漲幅 >= 0%，成交量變化率 >= 0%

### 使用方法

#### 選擇 Profile
1. 在「新手模式」下，找到「選擇策略風格（Profile）」區塊
2. 從下拉選單中選擇想要的 Profile（暴衝策略、穩健策略、長期策略）
3. 系統會自動顯示該 Profile 的說明和風險提示
4. 點擊「執行推薦分析」即可使用該 Profile 的配置

#### 策略建議（自動推薦）
1. 系統會根據當前市場狀態自動建議適合的 Profile
2. 在「策略建議」區塊中會顯示：
   - 當前市場狀態和信心度
   - 建議使用的 Profile
   - Profile 說明和風險等級
3. 點擊「一鍵套用建議 Profile」即可自動套用建議的配置

### 注意事項
- Profile 配置是預設值，可以在「進階模式」中手動調整
- 不同 Profile 適用不同的市場狀態，請根據當前市場環境選擇
- 風險等級僅供參考，實際投資仍需謹慎評估

---

## 推薦分析 - Explain 面板（分數拆解）

### 功能說明
Explain 面板提供推薦分數的詳細拆解，幫助使用者理解每檔股票的評分依據和潛在風險。

### 使用方法
1. 執行推薦分析後，推薦結果會顯示在右側表格中
2. **單擊**或**雙擊表格中的任意股票行**
3. 下方的「推薦理由詳情」區域會自動顯示：
   - **分數拆解**：總分、技術指標分數、圖形模式分數、成交量分數
   - **風險點**：各項風險提示

### 分數拆解說明

#### 總分
- **顏色標示：**
  - 🟢 綠色（>= 60）：綜合評分良好
  - 🟡 黃色（50-60）：綜合評分中等
  - 🔴 紅色（< 50）：綜合評分不足

#### 技術指標分數
- 評估技術指標的綜合表現
- 包含：RSI、MACD、KD、移動平均線、ADX 等指標的評分

#### 圖形模式分數
- 評估識別到的圖形模式強度
- 包含：W底、頭肩底、雙底等圖形模式的評分

#### 成交量分數
- 評估成交量的變化情況
- 包含：成交量放大、成交量突破等條件的評分

### 風險點提示

系統會自動檢測並提示以下風險：

1. **分數偏低警告**
   - 技術指標分數 < 50：可能缺乏技術面支撐
   - 圖形模式分數 < 40：圖形尚未完全形成
   - 成交量分數 < 50：可能缺乏資金關注

2. **總分評估**
   - 總分 < 50：綜合評分不足，建議謹慎
   - 總分 50-60：總分中等，建議觀察後續表現

3. **市場狀態不匹配**
   - 如果股票行為不完全匹配當前市場狀態，會提示已降權

4. **價格變化風險**
   - 價格下跌：需注意趨勢反轉風險
   - 價格漲幅過大（> 10%）：需注意追高風險

### 使用建議
- 優先關注總分 >= 60 的股票
- 注意風險點提示，避免高風險投資
- 結合 Why Not 解釋，全面了解股票評分

---

## 推薦分析 - 一鍵送回測

### 功能說明
一鍵送回測功能可以將推薦結果直接送到策略回測，自動載入股票清單和策略配置，無需手動重新設定。

### 使用方法

#### 步驟 1：執行推薦分析
1. 在「推薦分析」Tab 中選擇 Profile 或配置策略
2. 點擊「執行推薦分析」
3. 等待推薦結果顯示

#### 步驟 2：選擇股票
**方式一：選擇特定股票**
- 在推薦結果表格中**單擊**或**雙擊**要回測的股票行
- 可以按住 Ctrl 鍵多選多檔股票

**方式二：使用全部推薦股票**
- 不選擇任何股票（系統會自動使用前 20 檔）

#### 步驟 3：一鍵送回測
1. 點擊推薦結果上方的「一鍵送回測」按鈕
2. 系統會自動：
   - 切換到「策略回測」Tab
   - 創建選股清單並載入股票
   - 根據 Profile 風險等級自動設置執行價格
   - 設置日期範圍（預設最近 6 個月）

#### 步驟 4：執行回測
1. 檢查回測配置（日期範圍、初始資金等）
2. 選擇策略和設定參數
3. 點擊「執行回測」

### 自動配置說明

#### 執行價格自動設置
- **暴衝策略**：自動設置為「下一根K開盤價 (next_open)」（更激進）
- **穩健/長期策略**：自動設置為「當根K收盤價 (close)」（更保守）

#### 選股清單自動創建
- 系統會自動創建一個選股清單
- 清單名稱格式：`{Profile名稱}_{時間戳}`
- 清單來源標記為「recommendation」
- 清單描述包含 Profile 和 Regime 信息

#### 日期範圍自動設置
- 預設：最近 6 個月
- 可以手動調整

### 使用建議
- **單檔回測**：選擇 1 檔股票，詳細分析策略表現
- **批次回測**：選擇多檔股票，比較不同股票的表現
- **驗證推薦**：使用回測結果驗證推薦策略的有效性

### 注意事項
- 一鍵送回測最多載入 20 檔股票（避免過多）
- 如果選擇了股票，只會載入選中的股票
- 如果沒有選擇股票，會載入前 20 檔推薦股票
- 回測配置可以手動調整，不會影響推薦結果

---

## 策略回測 - 參數最佳化

### 功能說明
參數最佳化（Grid Search）可以自動掃描參數範圍，找出表現最好的參數組合。

**最新優化（2025-12-22）：**
- ✅ 數據預載入：所有參數組合共用同一份數據，大幅提升速度
- ✅ 多線程並行：使用多線程並行執行（最多 8 個線程）
- ✅ 日期自動調整：自動調整日期範圍到實際可用的數據範圍

### 使用步驟

#### 1. 準備工作
- 選擇股票代號（例如：2330）
- 設定回測日期範圍
- 選擇策略（例如：Baseline Score Threshold）

#### 2. 進入參數最佳化 Tab
- 在「策略回測」Tab 中，找到「結果」區域
- 點擊「參數最佳化」子 Tab

#### 3. 設定參數範圍
對於每個策略參數，你可以選擇：

**固定值模式：**
- 選擇「固定值」
- 輸入一個固定數值
- 此參數在掃描過程中保持不變

**範圍模式：**
- 選擇「範圍」
- 設定：
  - **最小**：參數的最小值
  - **最大**：參數的最大值
  - **步長**：每次增加的數值

**範例：**
假設要最佳化 `buy_score` 參數：
- 選擇「範圍」
- 最小：50
- 最大：80
- 步長：5
- 系統會測試：50, 55, 60, 65, 70, 75, 80（共 7 個值）

#### 4. 選擇目標指標
在「目標指標」下拉選單中選擇：
- **夏普比率**：風險調整後的報酬率（推薦）
- **年化報酬率**：單純的報酬率
- **CAGR-MDD權衡**：報酬率與最大回撤的平衡

#### 5. 執行最佳化
- 點擊「執行最佳化」按鈕
- 系統會顯示進度（完成 x/y 組參數）
- 等待掃描完成

#### 6. 查看結果
- 結果會顯示在表格中，按目標指標排序
- 排名 #1 的是最佳參數組合
- 表格顯示：
  - 排名
  - 各參數值
  - 夏普比率
  - 年化報酬率
  - 最大回撤
  - 勝率
  - 總交易次數

#### 7. 套用最佳參數
- **方法一**：雙擊表格中的任意行
- **方法二**：選擇行後，點擊「套用參數」按鈕
- 參數會自動填入主表單的策略參數欄位

#### 8. 執行回測驗證
- 套用參數後，回到「結果」Tab
- 點擊「執行回測」驗證最佳參數的表現

### 注意事項
- 參數組合數量 = 各範圍參數的組合數
- 例如：3 個參數，每個有 5 個值 = 5³ = 125 組參數
- 建議先用較大的步長快速掃描，再縮小範圍精細調整
- 掃描時間與參數組合數量和數據量成正比

### 性能優化
- ✅ **數據預載入**：系統會先載入一次數據，所有參數組合共用，大幅提升速度
- ✅ **多線程並行**：使用多線程並行執行回測（預設使用 CPU 核心數，最多 8 個線程）
- ✅ **日期自動調整**：如果選擇的日期範圍超過實際數據，系統會自動調整並提示

### 日期範圍自動調整
如果選擇的日期範圍超過實際數據範圍，系統會：
1. **自動調整**：將日期範圍調整為實際可用的數據範圍
2. **顯示提示**：在回測完成時顯示調整訊息
3. **記錄實際範圍**：在績效摘要中顯示實際使用的日期範圍

**範例：**
- 請求範圍：2024-12-22 ~ 2025-12-22
- 實際數據：2024-12-23 ~ 2025-12-19
- 系統會自動調整為：2024-12-23 ~ 2025-12-19
- 並顯示提示：「日期範圍已自動調整: 請求 2024-12-22~2025-12-22 → 實際 2024-12-23~2025-12-19」

### 範例：最佳化 Baseline Score Threshold 策略

1. **選擇策略**：Baseline Score Threshold
2. **設定參數範圍**：
   - `buy_score`：範圍 50-80，步長 5（7 個值）
   - `sell_score`：範圍 30-50，步長 5（5 個值）
   - `buy_confirm_days`：固定值 2
   - `sell_confirm_days`：固定值 2
   - `cooldown_days`：固定值 3
3. **總組合數**：7 × 5 = 35 組參數
4. **目標指標**：夏普比率
5. **執行並等待**：系統會測試所有 35 組參數
6. **查看結果**：找出夏普比率最高的參數組合
7. **套用並驗證**：雙擊最佳結果，執行回測驗證

---

## 策略回測 - Walk-forward 驗證

### 功能說明
Walk-forward 驗證用於評估策略在不同時期的穩定性，防止過擬合。

### 兩種驗證模式

#### 模式 1：Train-Test Split（訓練-測試分割）

**概念：**
- 將數據分為兩部分：訓練集和測試集
- 在訓練集上優化參數
- 在測試集上驗證表現

**使用步驟：**
1. 選擇「Train-Test Split」模式
2. 設定「訓練/測試比例」（預設 0.7，即 70% 訓練，30% 測試）
3. 點擊「執行驗證」
4. 系統會：
   - 將日期範圍按比例分割
   - 在訓練期執行回測
   - 在測試期執行回測
   - 比較兩期的表現

**結果解讀：**
- 如果測試期表現接近訓練期：策略穩定
- 如果測試期表現明顯下降：可能過擬合

#### 模式 2：Walk-forward（滾動窗口）

**概念：**
- 使用滾動窗口，多次訓練和測試
- 每次向前移動一定時間，重新訓練和測試
- 評估策略在不同時期的表現穩定性

**使用步驟：**
1. 選擇「Walk-forward」模式
2. 設定參數：
   - **訓練期（月）**：每次訓練使用的月數（預設 6 個月）
   - **測試期（月）**：每次測試使用的月數（預設 3 個月）
   - **步進（月）**：每次向前移動的月數（預設 3 個月）
   - **暖機期天數**（Phase 3.3b 新增，預設 0）：確保技術指標計算有足夠歷史數據
3. 點擊「執行驗證」
4. 系統會：
   - 從開始日期起，先經過暖機期（如果設定）
   - 使用訓練期數據訓練（從「開始日期 + 暖機期」開始）
   - 在接下來的測試期驗證
   - 向前移動步進月數
   - 重複上述過程，直到覆蓋整個日期範圍

**暖機期說明**（Phase 3.3b 新增）：
- **目的**：確保技術指標（如 MA、RSI、MACD）有足夠的歷史數據進行計算
- **建議值**：20-60 個交易日（約 1-3 個月）
- **影響**：訓練期會從「開始日期 + 暖機期」開始計算，而不是從開始日期
- **範例**：如果開始日期是 2020-01-01，暖機期是 20 天，訓練期是 6 個月
  - 暖機期：2020-01-01 ~ 2020-01-20（用於計算技術指標，不參與訓練）
  - 訓練期：2020-01-21 ~ 2020-07-20（實際訓練數據）

**範例：**
- 日期範圍：2020-01-01 到 2023-12-31（4 年）
- 訓練期：6 個月
- 測試期：3 個月
- 步進：3 個月

**執行過程：**
1. 訓練：2020-01-01 ~ 2020-06-30，測試：2020-07-01 ~ 2020-09-30
2. 訓練：2020-04-01 ~ 2020-09-30，測試：2020-10-01 ~ 2020-12-31
3. 訓練：2020-07-01 ~ 2020-12-31，測試：2021-01-01 ~ 2021-03-31
4. ...（依此類推）

**結果解讀：**
- 查看每次測試期的表現
- 如果各期表現穩定：策略在不同時期都有效
- 如果表現波動大：策略可能不穩定

### 使用建議

1. **先執行 Train-Test Split**：
   - 快速評估策略是否過擬合
   - 如果測試期表現明顯下降，需要調整策略

2. **再執行 Walk-forward**：
   - 更詳細地評估策略穩定性
   - 查看策略在不同市場環境下的表現

3. **參數設定建議**：
   - **訓練期**：至少 6 個月，確保有足夠數據
   - **測試期**：3-6 個月，不要太短
   - **步進**：建議與測試期相同，避免重疊

4. **日期範圍建議**：
   - 至少 1 年數據（Walk-forward 模式）
   - 建議 2-3 年數據，獲得更多驗證期

### 注意事項
- Walk-forward 驗證需要較長時間（多次回測）
- 建議先用單一股票測試，確認功能正常
- 如果驗證結果不理想，考慮：
  - 調整策略參數
  - 更換策略
  - 縮小適用範圍（特定 Regime 或產業）

---

## 策略回測 - Baseline 對比與過擬合風險（Phase 3.3b 新增）

### Baseline 對比

**功能說明：**
Baseline 對比用於評估策略是否優於被動持有（Buy & Hold）基準，幫助判斷策略的實際價值。

**對比指標：**
- **Baseline 總報酬率**：Buy & Hold 策略的總報酬率
- **策略總報酬率**：回測策略的總報酬率
- **超額報酬率（Excess Return）**：策略報酬率 - Baseline 報酬率
- **相對 Sharpe 比率**：策略 Sharpe 比率相對於 Baseline 的改善
- **統計顯著性（p-value）**：策略表現優於 Baseline 的統計顯著性

**結果解讀：**
- **超額報酬率 > 0**：策略優於 Buy & Hold
- **超額報酬率 < 0**：策略不如 Buy & Hold，需要重新評估
- **p-value < 0.05**：策略表現優於 Baseline 具有統計顯著性

**注意事項：**
- Baseline 對比會自動在回測報告中顯示
- 如果策略表現不如 Baseline，建議重新調整策略參數或更換策略

### 過擬合風險提示

**功能說明：**
過擬合風險提示用於識別策略是否過度擬合歷史數據，評估策略在未來表現的穩定性。

**風險等級：**
- **低風險（0.0 - 3.0）**：策略穩定性良好，過擬合風險低
- **中風險（3.0 - 6.0）**：策略穩定性中等，需要進一步驗證
- **高風險（6.0 - 10.0）**：策略穩定性差，過擬合風險高，不建議使用

**風險指標：**
1. **Walk-Forward 退化程度（Degradation）**：
   - 測試期相對於訓練期的表現退化程度
   - 退化程度越高，過擬合風險越高
2. **一致性標準差（Consistency）**：
   - 多個 Walk-Forward Fold 之間表現的一致性
   - 標準差越大，一致性越差，過擬合風險越高
3. **參數敏感性（Parameter Sensitivity）**：
   - 參數微小變化對策略表現的影響
   - 敏感性越高，過擬合風險越高（需要最佳化結果）

**使用建議：**
1. **必須提供 Walk-Forward 結果**：過擬合風險計算需要 Walk-Forward 驗證結果
2. **優先關注低風險策略**：風險等級為「低」的策略更可靠
3. **中高風險策略需謹慎**：建議進一步調整參數或縮小適用範圍
4. **結合 Baseline 對比**：即使過擬合風險低，也要確保優於 Baseline

**注意事項：**
- 如果未提供 Walk-Forward 結果，過擬合風險會顯示為 `None`（這是預期行為）
- 過擬合風險提示僅供參考，實際投資仍需謹慎評估

---

## 策略回測 - Promote 機制（Phase 3.3b 新增）

### 功能說明

Promote 機制可以將通過驗證的回測結果升級為策略版本，並在推薦分析中使用。

### 升級條件

系統會自動檢查以下條件：

1. **Walk-Forward 驗證通過**：
   - 一致性（Consistency）>= 60%
   - 平均退化程度（Average Degradation）< 40%

2. **Baseline 對比優於基準**：
   - 總報酬率 > Buy & Hold 總報酬率
   - Sharpe Ratio > Buy & Hold Sharpe Ratio（或 > 0.5）

3. **風險指標可接受**：
   - 最大回撤 < 30%（可調整）
   - 勝率 > 50%（可調整）

### 使用方法

#### 步驟 1：執行回測並查看結果
1. 在「策略回測」Tab 中執行回測
2. 查看回測結果，確認表現良好
3. 建議先執行 Walk-Forward 驗證，確保策略穩定性

#### 步驟 2：檢查升級條件
1. 點擊回測結果區域的「Promote」按鈕
2. 系統會自動檢查升級條件
3. 查看檢查結果：
   - **通過**：所有條件都滿足，可以升級
   - **未通過**：顯示未通過的條件和原因

#### 步驟 3：升級為策略版本
1. 如果通過條件檢查，輸入版本名稱（可選，留空則自動生成）
2. 輸入備註（可選，例如：適用於 Trend 市場）
3. 點擊「確認」完成升級

#### 步驟 4：在推薦分析中使用
1. 回到「推薦分析」Tab
2. 在策略配置中，可以選擇已 Promote 的策略版本
3. 系統會自動載入該版本的參數配置

### 注意事項

- **只有通過升級條件的回測結果才能 Promote**
- **Promote 後的策略版本會保存完整的參數、配置和回測摘要**
- **可以在推薦分析中選擇已 Promote 的策略版本作為參數預設**
- **建議在 Promote 前先執行 Walk-Forward 驗證，確保策略穩定性**

---

## 常見問題

### Q: 參數最佳化沒有顯示參數？
A: 請先選擇策略，系統會自動載入該策略的參數列表。

### Q: Walk-forward 驗證很慢？
A: 這是正常的，因為需要執行多次回測。建議：
- 縮短日期範圍
- 減少 Walk-forward 的測試次數（增加步進）
- 使用較快的電腦

### Q: 參數最佳化時顯示「找不到技術指標數據」？
A: 可能原因：
1. **技術指標文件不存在**：請先執行技術指標計算腳本
   ```bash
   python scripts/calculate_technical_indicators.py --force-all
   ```
2. **日期範圍超出數據範圍**：系統會自動調整日期範圍，使用實際可用的數據
3. **日期格式問題**：已修復，系統現在能正確解析 YYYYMMDD 格式的日期

### Q: 參數最佳化很慢？
A: 已優化！現在系統會：
- 預先載入數據一次，所有參數組合共用
- 使用多線程並行執行（最多 8 個線程）
- 大幅減少 I/O 操作和重複計算

如果還是很慢，建議：
- 減少參數範圍（使用較大步長）
- 先測試少量參數組合，確認策略有效
- 縮短日期範圍

### Q: 產業列表為空？
A: 請檢查：
- `data/meta_data/companies.csv` 是否存在
- 文件是否正確載入
- 查看終端是否有錯誤訊息

---

---

## 策略回測 - Phase 2.5 新參數使用指南

### 執行價格選擇

**功能說明：**
- 控制回測時的交易執行價格
- 影響回測結果的準確性和真實性

**選項：**
1. **下一根K開盤價 (next_open)**（推薦，預設）
   - 使用信號產生後下一根K線的開盤價執行
   - 避免「偷看未來」的問題
   - 更接近實際交易情況

2. **當根K收盤價 (close)**
   - 使用信號產生當根K線的收盤價執行
   - 可能導致過度樂觀的回測結果
   - 僅用於特殊情況

**使用建議：**
- 一般情況下使用「下一根K開盤價」
- 只有在需要比較不同執行價格影響時才切換

### 停損停利模式切換

**功能說明：**
- 提供兩種停損停利設定方式
- 可根據策略特性選擇合適的模式

**百分比模式：**
- 適用於：固定風險比例的策略
- 設定方式：直接輸入百分比（例如：5% 停損，10% 停利）
- 優點：簡單直觀
- 缺點：不同波動度的股票效果差異大

**ATR 倍數模式（推薦）：**
- 適用於：需要根據波動度調整的策略
- 設定方式：輸入 ATR 倍數（例如：2 × ATR 停損，3 × ATR 停利）
- 優點：自動適應不同股票的波動度
- 缺點：需要理解 ATR 概念

**使用建議：**
- 新手：先使用百分比模式
- 進階：使用 ATR 倍數模式，更符合實際交易
- 切換模式時，系統會自動顯示/隱藏對應的輸入框

### 部位管理參數

**最大持有部位數：**
- 限制同時持有的股票數量
- 預設：1（單檔策略）
- 多檔策略：可設定為 2-50
- 設定為 0：無限制（不建議）

**部位加權方式：**
- **等權重**（預設）：每檔股票分配相同資金
- **分數加權**：根據推薦分數分配資金（分數越高，資金越多）
- **波動調整**：根據股票波動度調整資金分配（波動度越低，資金越多）

**允許加碼：**
- 啟用後，可以在已持有股票上繼續加碼
- 預設：關閉（避免過度集中風險）
- 僅在特殊策略中啟用

**允許重新進場：**
- 控制是否允許在賣出後重新買入同一檔股票
- 預設：開啟
- 關閉時：賣出後不再買入（避免頻繁交易）

**重新進場冷卻天數：**
- 賣出後需要等待的天數才能重新買入
- 預設：5 天
- 僅在「允許重新進場」開啟時生效
- 用於避免頻繁進出場

**使用建議：**
- 單檔策略：保持預設值（max_positions=1，等權重）
- 多檔策略：根據策略特性調整 max_positions 和 position_sizing
- 避免過度交易：啟用 reentry_cooldown_days

---

---

## 策略回測 - 數據載入說明

### 回測時使用的數據文件

當您在 UI 中選擇股票（例如：2330）並執行回測或參數最佳化時，系統會讀取以下文件：

#### 1. 價格數據
**文件路徑：** `D:/Min/Python/Project/FA_Data/meta_data/stock_data_whole.csv`

**載入邏輯：**
- 讀取整個文件
- 過濾出指定股票代號的數據
- 過濾日期範圍（根據設定的開始/結束日期）
- 包含欄位：開盤、最高、最低、收盤、成交量等

#### 2. 技術指標數據
**文件路徑：** `D:/Min/Python/Project/FA_Data/technical_analysis/2330_indicators.csv`

**載入邏輯：**
- 直接讀取對應股票的技術指標文件
- 過濾日期範圍（與價格數據相同）
- 包含欄位：RSI、MACD、KD、MA、ADX、ATR 等技術指標
- 如果文件不存在，系統會顯示警告但仍可執行回測（只使用價格數據）

#### 3. 數據合併
- 以價格數據為主（`left join`）
- 根據日期索引合併技術指標數據
- 如果技術指標文件不存在，只使用價格數據

### 日期範圍自動調整

**功能說明：**
- 如果選擇的日期範圍超過實際數據範圍，系統會自動調整
- 例如：請求 2024-12-22 ~ 2025-12-22，但數據只到 2025-12-19
- 系統會自動調整為：2024-12-23 ~ 2025-12-19（根據實際數據範圍）

**提示訊息：**
- 回測完成時會顯示日期調整對話框
- 績效摘要中會顯示實際使用的日期範圍
- 如果日期被調整，會顯示警告訊息

### 技術指標計算

**重要：** 技術指標需要先計算才能用於回測。

**計算方式：**
```bash
# 計算所有股票的技術指標
python scripts/calculate_technical_indicators.py --force-all

# 計算特定股票的技術指標
python scripts/calculate_technical_indicators.py --stock 2330
```

**注意事項：**
- 技術指標計算腳本**未整合到 UI**，需要手動執行
- 計算完成後，技術指標文件會保存在 `technical_analysis/` 目錄
- 增量更新時，系統會自動合併新舊數據，不會覆蓋舊數據

---

---

## 推薦分析 - Why Not（反向解釋）

### 功能說明
Why Not 功能提供反向解釋，說明為什麼股票未被推薦或分數較低，幫助使用者理解篩選邏輯。

### 使用方法
1. 執行推薦分析後，選擇任意股票行
2. 在「推薦理由詳情」區域下方會顯示「Why Not」區塊
3. 查看未達到的條件和偏差值

### Why Not 內容說明

#### 未達到的篩選條件
- **漲幅篩選**：如果股票漲幅未達到設定的最小值
- **成交量篩選**：如果股票成交量變化率未達到設定的最小值
- **RSI 篩選**：如果股票 RSI 超出設定的範圍

#### 分數偏差
- 顯示實際分數與理想分數的差距
- 幫助理解為什麼某些股票分數較低

### 使用建議
- 結合 Why 和 Why Not，全面了解股票評分
- 如果 Why Not 顯示的條件可以調整，可以考慮修改篩選條件

---

## 推薦分析 - 結果保存與追溯

### 功能說明
推薦結果可以保存到資料庫，包含完整的策略配置、市場狀態和 Profile 信息，方便後續追溯和分析。

### 使用方法

#### 保存推薦結果
1. 執行推薦分析後，推薦結果會顯示在表格中
2. 點擊推薦結果上方的「保存結果」按鈕
3. 輸入結果名稱（可選，預設會自動生成）
4. 點擊「確定」保存

#### 保存內容
保存的結果包含：
- **推薦股票列表**：所有推薦的股票及其評分
- **策略配置**：完整的技術指標、圖形模式、篩選條件配置
- **Profile 信息**：Profile ID、名稱、版本號
- **市場狀態快照**：Regime、信心度、詳細信息、檢測時間
- **創建時間**：結果生成的時間戳

### 使用建議
- 定期保存推薦結果，建立歷史記錄
- 使用有意義的結果名稱，方便後續查找
- 結合回測結果，分析推薦策略的有效性

---

## 數據更新 - 券商分點資料

### 功能說明
券商分點資料更新功能可以從 MoneyDJ 抓取指定券商分點的每日買賣資料，用於分析籌碼流向。

### 追蹤的分點
系統目前追蹤 6 個券商分點：
1. **永豐竹北**（9A00_9A9P）
2. **凱基台北**（9200_9268）
3. **凱基信義**（9200_9216）
4. **凱基松山**（9200_9217）
5. **群益民權**（9100_9131）
6. **康和永和**（8450_845B）

### 使用方法

#### 步驟 1：更新每日資料
1. 打開「數據更新」Tab
2. 在「更新類型」中選擇「券商分點資料」
3. 設定日期範圍（開始日期和結束日期）
4. 點擊「開始更新」
5. 系統會顯示進度，並自動處理所有追蹤的分點

#### 步驟 2：合併資料
1. 更新完成後，點擊「合併券商分點資料」按鈕
2. 系統會將每日資料合併到各分點的歷史資料檔案中
3. 合併後的資料會自動去重

### 資料存儲位置

**每日原始資料**：
```
D:\Min\Python\Project\FA_Data\broker_flow\{branch_system_key}\daily\{YYYY-MM-DD}.csv
```

**合併後的歷史資料**：
```
D:\Min\Python\Project\FA_Data\broker_flow\{branch_system_key}\meta\merged.csv
```

**範例**：
- 凱基台北每日資料：`broker_flow/9200_9268/daily/2024-11-08.csv`
- 凱基台北合併資料：`broker_flow/9200_9268/meta/merged.csv`

### 資料欄位說明

每日 CSV 檔案包含以下欄位：
- `date`：日期（YYYY-MM-DD）
- `trade_type`：交易類型（買超/賣超）
- `branch_system_key`：分點系統鍵（例如：9200_9268）
- `branch_broker_code`：分點券商代碼（例如：9200）
- `branch_code`：分點代碼（例如：9268）
- `branch_display_name`：分點顯示名稱（例如：凱基台北）
- `counterparty_broker_code`：對手券商代碼
- `counterparty_broker_name`：對手券商名稱
- `buy_qty`：買進數量
- `sell_qty`：賣出數量
- `net_qty`：淨數量（買進 - 賣出）

### 資料狀態檢查

在「數據狀態」面板中，可以查看：
- **最新日期**：各分點資料的最新日期
- **總記錄數**：各分點的總記錄數
- **狀態**：資料完整性狀態

### 注意事項

1. **更新時間**：建議在交易日收盤後更新，確保資料完整
2. **請求間隔**：系統預設使用 4 秒延遲，避免對網站造成負擔
3. **自動跳過**：如果某日資料已存在，系統會自動跳過（除非選擇「強制重新抓取」）
4. **Driver 自動恢復**：如果 ChromeDriver 崩潰，系統會自動重新創建並繼續執行
5. **重試機制**：每個日期最多重試 3 次，自動處理暫時性錯誤

### 常見問題

**Q: 更新時出現 ChromeDriver 錯誤？**
A: 系統已實現自動恢復機制，會自動重新創建 driver 並繼續執行。如果問題持續，請檢查 Chrome 瀏覽器是否已安裝。

**Q: 資料顯示中文亂碼？**
A: 系統已修復編碼問題，所有檔案使用 UTF-8 with BOM 編碼，Excel 可直接開啟。

**Q: 如何新增追蹤分點？**
A: 需要修改 `{meta_data_dir}/broker_branch_registry.csv` 檔案，添加新的分點資訊。

---

**最後更新：2026-01-02（Phase 3.3b 完成：研究閉環完整化、Walk-forward 暖機期、Baseline 對比、過擬合風險提示、Promote 機制）**

