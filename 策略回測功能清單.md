# 策略回測頁面功能清單與開發進度

## 📋 整體架構

**頁面布局**：左右分割（QSplitter）
- **左側**：配置面板（可滾動，最小寬度 400px）
- **右側**：結果顯示面板（Tab 組織，5 個 Tab）

---

## 🔧 左側配置面板功能

### 1. ✅ 策略預設 (Strategy Preset)
**狀態**：已完成  
**功能**：
- 下拉選單選擇已保存的策略預設
- 儲存當前策略設定（名稱、策略ID、參數）
- 載入已保存的預設
- 刪除預設

**後端服務**：`PresetService`  
**儲存格式**：JSON 檔案  
**位置**：`app_module/preset_service.py`

---

### 2. ✅ 回測配置 (Backtest Configuration)
**狀態**：已完成  
**功能**：

#### 2.1 股票選擇模式
- **單一股票模式**：輸入單一股票代號
- **選股清單模式**：從已保存的 watchlist 選擇

#### 2.2 選股清單管理
- 創建新清單（名稱 + 股票代號列表）
- 編輯現有清單
- 刪除清單
- 清單顯示格式：`清單名稱 (N檔)`

**後端服務**：`UniverseService`  
**儲存格式**：JSON 檔案  
**位置**：`app_module/universe_service.py`

#### 2.3 日期範圍
- 開始日期選擇器（預設：1年前）
- 結束日期選擇器（預設：今天）
- 日期格式：`yyyy-MM-dd`

#### 2.4 初始資金
- 範圍：$10,000 ~ $100,000,000
- 預設：$1,000,000

#### 2.5 交易成本
- 手續費 (bps)：預設 14.25
- 滑點 (bps)：預設 5.0

#### 2.6 風險控制
- 停損比例 (%)：可選
- 停利比例 (%)：可選

---

### 3. ✅ 部位 Sizing
**狀態**：已完成  
**功能**：
- **全倉模式**：使用全部資金
- **固定金額模式**：每次買入固定金額（需輸入金額）
- **風險百分比模式**：基於風險百分比計算部位大小（需輸入風險%）

**後端整合**：`BrokerSimulator` 支援三種 sizing 模式

---

### 4. ✅ 市場限制 (Market Constraints)
**狀態**：已完成  
**功能**：
- **啟用漲跌停限制**：檢查台股漲跌停板，無法成交時延後或取消
- **啟用成交量約束**：限制每日最大參與率
- **最大參與率 (%)**：預設 5.0%，限制每日成交量使用比例

**後端整合**：`BrokerSimulator` 支援價格限制和成交量約束

---

### 5. ✅ 策略配置 (Strategy Configuration)
**狀態**：已完成  
**功能**：
- 策略下拉選單（從 `StrategyRegistry` 動態載入）
- 策略描述顯示
- **動態參數表單**：根據選中策略的 `params` 定義自動生成輸入控件
  - 支援 `int` 類型：`QSpinBox`
  - 支援 `float` 類型：`QDoubleSpinBox`
  - 每個參數顯示描述和預設值

---

### 6. ✅ 參數最佳化 (Parameter Optimization / Grid Search)
**狀態**：已完成（基礎功能）  
**功能**：
- **目標指標選擇**：CAGR、Sharpe、MDD、CAGR-MDD
- **動態參數範圍設定**：為每個策略參數設定
  - 模式選擇：固定值 / 範圍
  - 範圍模式：最小値、最大値、步長
- **執行參數掃描**：背景執行，顯示進度條
- **結果顯示**：在「最佳化」Tab 顯示排名表格

**後端服務**：`OptimizerService`  
**位置**：`app_module/optimizer_service.py`

**待改進**：
- ⚠️ TODO: 實作進度回調（目前沒有顯示掃描進度）
- 結果表格可點擊套用參數到主面板

---

### 7. ✅ Walk-forward 驗證
**狀態**：已完成  
**功能**：

#### 7.1 模式選擇
- **Train-Test Split**：單次切分驗證
  - 訓練/測試比例：預設 0.7（70% 訓練，30% 測試）
- **Walk-forward**：滾動窗口驗證
  - 訓練月數：預設 6 個月
  - 測試月數：預設 3 個月
  - 步長月數：預設 3 個月

#### 7.2 結果顯示
- Train-Test Split：顯示訓練集和測試集績效，計算退化程度
- Walk-forward：顯示每個 fold 的結果表格和整體摘要

**後端服務**：`WalkForwardService`  
**位置**：`app_module/walkforward_service.py`

---

### 8. ✅ 執行按鈕
**狀態**：已完成  
**功能**：
- **執行回測**：單一股票或批次回測
- **保存結果**：將當前回測結果保存到資料庫（回測完成後啟用）

---

## 📊 右側結果面板（5 個 Tab）

### Tab 1: ✅ 結果 (Results)
**狀態**：已完成  
**功能**：

#### 1.1 績效摘要
顯示文字格式的績效指標：
- 總報酬率
- 年化報酬率 (CAGR)
- 夏普比率
- 最大回撤
- 勝率
- 總交易次數
- 期望值
- 獲利因子
- 平均獲利/虧損
- 最大獲利/虧損
- 最終權益

#### 1.2 交易明細
表格顯示所有交易記錄：
- 進場日期
- 出場日期
- 進場價格
- 出場價格
- 股數
- 報酬
- 報酬率%
- 持有天數
- 理由標籤

**表格功能**：
- 可排序
- 可選擇行
- 交替行顏色
- 自動調整欄寬

---

### Tab 2: ✅ 圖表 (Charts)
**狀態**：已完成  
**功能**：

#### 2.1 Run 選擇器
- 下拉選單選擇已保存的回測結果
- 自動載入並顯示該結果的所有圖表

#### 2.2 圖表子 Tab（4 張圖表）

**2.2.1 權益曲線 (Equity Curve)**
- 顯示策略權益隨時間變化
- 可選：疊加基準（TAIEX）曲線
- 顯示 CAGR 在標題中
- 支援中文顯示

**2.2.2 回撤曲線 (Drawdown Curve)**
- 顯示回撤百分比隨時間變化
- 標記最大回撤點和日期
- 標記回撤區間（峰值到最大回撤）
- 可選：標記恢復日期和恢復天數

**2.2.3 交易報酬分佈 (Trade Return Distribution)**
- 直方圖顯示每筆交易的報酬率分佈
- 顏色區分：綠色（獲利）、紅色（虧損）
- 標記平均值、中位數
- 可選：標記 95% VaR

**2.2.4 持有天數分佈 (Holding Period Distribution)**
- 直方圖顯示持有天數分佈
- 標記平均值、中位數
- 自動判斷策略類型（短打/短線/波段/長期）

**圖表技術**：
- 使用 Matplotlib + QtAgg 後端
- 支援中文字體（Microsoft JhengHei）
- 圖表尺寸：12x8（可隨窗口調整）

**後端服務**：`ChartDataService`  
**位置**：`app_module/chart_data_service.py`  
**Widget 位置**：`ui_qt/widgets/chart_widget.py`

---

### Tab 3: ✅ 最佳化 (Optimization)
**狀態**：已完成  
**功能**：
- 顯示參數掃描結果表格
- 欄位：參數組合、CAGR、Sharpe、MDD、勝率、交易次數等
- 按目標指標排序
- 可點擊行套用參數到主面板（待實作）

---

### Tab 4: ✅ 比較 (Comparison)
**狀態**：已完成  
**功能**：

#### 4.1 回測歷史列表
- 顯示已保存的回測結果列表
- 格式：`執行名稱 | 股票代號 | 策略ID | 日期時間`
- 可選擇多個結果（支援多選）
- 雙擊項目：載入該結果的詳細資訊到「結果」Tab

#### 4.2 操作按鈕
- **重新整理**：刷新歷史列表
- **刪除選中**：刪除選中的回測結果（支援單選和多選）
  - 刪除前顯示確認對話框
  - 刪除資料庫記錄和相關檔案（equity curve、trade list）
  - 顯示刪除結果統計（成功/失敗數量）
  - 自動刷新列表和圖表下拉選單

#### 4.3 比較表格
- 點擊「比較選中」按鈕
- 顯示多個結果的對比表格
- 欄位：執行名稱、股票代號、策略、總報酬率、年化報酬率、夏普比率、最大回撤、勝率、交易次數、期望值、獲利因子

**後端服務**：`BacktestRunRepository`  
**位置**：`app_module/backtest_repository.py`  
**刪除方法**：`BacktestRunRepository.delete_run()`（第 377-405 行）

---

### Tab 5: ✅ 批次結果 (Batch Results)
**狀態**：已完成  
**功能**：

#### 5.1 排行榜表格
顯示批次回測的股票排名：
- **欄位**：
  - 股票代號
  - CAGR%
  - Sharpe
  - MDD%
  - Trades（交易次數）
  - WinRate%
  - PF（獲利因子）
  - 是否成交（是否成功回測）
  - 失敗原因（如果失敗）

- **排序選項**：
  - CAGR-MDD（預設）
  - CAGR
  - Sharpe
  - MDD

- **互動功能**：
  - 雙擊行：載入該股票的詳細結果到「結果」和「圖表」Tab

#### 5.2 整體統計
顯示批次回測的整體統計：
- 總股票數
- 成功回測數
- 賺錢股票數
- 股票層級勝率
- CAGR 中位數
- MDD 中位數

**後端服務**：`BatchBacktestService`  
**位置**：`app_module/batch_backtest_service.py`

**批次回測流程**：
1. 檢測到選股清單模式時自動觸發批次回測
2. 逐一執行單檔回測
3. 自動保存每個結果到資料庫
4. 聚合結果生成排行榜和統計
5. 自動切換到「批次結果」Tab

---

## 💾 資料持久化

### ✅ 回測結果保存 (Backtest Run Archive)
**狀態**：已完成  
**功能**：

#### 儲存內容
- **SQLite 資料庫**：儲存回測元數據
  - 執行ID、名稱、股票代號、日期範圍
  - 策略ID、參數（JSON）
  - 資金、成本設定
  - 績效指標（CAGR、Sharpe、MDD 等）
  - 備註、標籤
  - 創建時間

- **Parquet/CSV 檔案**：儲存大型數據
  - Equity Curve（權益曲線）：每日權益值
  - Trade List（交易明細）：所有交易記錄
  - 自動降級：如果 parquet 不可用，改用 CSV

#### 載入功能
- 從資料庫載入元數據
- 從檔案載入 equity curve 和 trade list
- 支援 parquet 和 CSV 兩種格式

**後端服務**：`BacktestRunRepository`  
**位置**：`app_module/backtest_repository.py`  
**資料庫位置**：`{output_dir}/backtest_runs/runs.db`  
**檔案位置**：`{output_dir}/backtest_runs/`

---

## 🔄 背景任務處理

### ✅ TaskWorker
**狀態**：已完成  
**功能**：
- 所有耗時操作在背景執行（不阻塞 UI）
- 支援進度條顯示
- 支援錯誤處理和回調

**位置**：`ui_qt/workers/task_worker.py`

**使用場景**：
- 單檔回測
- 批次回測
- 參數掃描
- Walk-forward 驗證

---

## 🎨 UI/UX 特性

### ✅ 響應式布局
- 左右面板可調整大小（QSplitter）
- 左側配置面板可滾動（QScrollArea）
- 表格欄寬可調整（QHeaderView.Interactive）
- 圖表隨窗口大小調整

### ✅ 中文支援
- 所有 UI 文字使用繁體中文
- 圖表支援中文顯示（Microsoft JhengHei 字體）
- 錯誤訊息使用中文

---

## ⚠️ 已知問題與待改進

### 1. 參數最佳化進度回調
**狀態**：待實作  
**問題**：參數掃描時沒有顯示進度（已完成/總數）  
**位置**：`ui_qt/views/backtest_view.py` 第 1719 行附近  
**備註**：`OptimizerService.grid_search` 需要支援進度回調

### 2. 最佳化結果套用功能
**狀態**：待實作  
**問題**：最佳化結果表格點擊後無法套用參數到主面板  
**建議**：添加「套用參數」按鈕或雙擊事件

### 3. 圖表互動功能
**狀態**：基礎完成，可擴展  
**當前**：靜態圖表  
**建議**：
- 縮放功能
- 十字線（顯示具體數值）
- Tooltip（懸停顯示詳細資訊）

### 4. 批次回測進度顯示
**狀態**：基礎完成  
**當前**：只顯示進度條，沒有文字進度（例如：3/10）  
**建議**：顯示「正在回測 2330 (3/10)」

### 5. 回測結果匯出
**狀態**：待實作  
**建議**：
- 匯出 Excel（包含摘要和明細）
- 匯出 PDF 報告
- 匯出圖表為圖片

### 6. 回測結果篩選與搜尋
**狀態**：待實作  
**建議**：
- 在「比較」Tab 添加篩選器（按策略、股票、日期範圍）
- 搜尋功能（按名稱、股票代號）

### 9. ✅ 回測歷史刪除功能
**狀態**：已完成  
**功能**：
- 支援單選和多選刪除
- 刪除前確認對話框（顯示要刪除的項目）
- 刪除資料庫記錄和相關檔案
- 顯示刪除結果統計
- 自動刷新列表和圖表下拉選單

**位置**：`ui_qt/views/backtest_view.py` → `_delete_history_runs()`（第 1554-1605 行）

### 7. 策略參數驗證
**狀態**：部分完成  
**當前**：只有 UI 層面的範圍限制  
**建議**：
- 參數合理性檢查（例如：買入閾值 > 賣出閾值）
- 策略層面的參數驗證

### 8. 錯誤處理與使用者提示
**狀態**：基礎完成  
**當前**：大部分錯誤只顯示在控制台  
**建議**：
- 更友好的錯誤訊息對話框
- 錯誤日誌檔案
- 操作成功提示

---

## 📈 功能完成度統計

### 核心功能
- ✅ 單檔回測：100%
- ✅ 批次回測：100%
- ✅ 結果保存與載入：100%
- ✅ 結果比較：100%
- ✅ 結果刪除：100%
- ✅ 圖表視覺化：100%

### 進階功能
- ✅ 策略預設：100%
- ✅ 選股清單：100%
- ✅ 參數最佳化：90%（缺進度回調）
- ✅ Walk-forward 驗證：100%

### 回測引擎
- ✅ 基本回測：100%
- ✅ 部位 Sizing：100%
- ✅ 市場限制（漲跌停、成交量）：100%
- ✅ 成本計算：100%
- ✅ 風險控制（停損停利）：100%

### UI/UX
- ✅ 響應式布局：100%
- ✅ 中文支援：100%
- ✅ 背景任務：100%
- ⚠️ 進度顯示：70%（缺詳細進度文字）

---

## 🎯 建議優先改進項目

### 高優先級
1. **參數最佳化進度回調**：提升使用者體驗
2. **最佳化結果套用功能**：提高工作效率
3. **批次回測進度顯示**：讓使用者知道進度

### 中優先級
4. **回測結果匯出**：方便分享和報告
5. **結果篩選與搜尋**：當結果很多時很有用
6. **圖表互動功能**：提升分析體驗

### 低優先級
7. **策略參數驗證**：防止錯誤配置
8. **錯誤處理改進**：提升穩定性

---

## 📝 技術架構總結

### 服務層
- `BacktestService`：核心回測邏輯
- `PresetService`：策略預設管理
- `UniverseService`：選股清單管理
- `BacktestRunRepository`：結果持久化
- `OptimizerService`：參數最佳化
- `WalkForwardService`：Walk-forward 驗證
- `ChartDataService`：圖表數據提供
- `BatchBacktestService`：批次回測協調

### 資料層
- SQLite：回測元數據
- Parquet/CSV：大型數據（equity curve、trade list）
- JSON：策略預設、選股清單

### UI 層
- `BacktestView`：主視圖
- `ChartWidget`：圖表組件（4 種）
- `PandasTableModel`：表格數據模型
- `TaskWorker`：背景任務處理

---

**最後更新**：2025-12-16  
**版本**：v1.1

## 📝 更新日誌

### v1.1 (2025-12-16)
- ✅ 新增：回測歷史刪除功能（支援單選和多選）
- ✅ 修復：圖表顯示問題（回撤曲線、報酬分佈、持有天數）
- ✅ 修復：保存結果按鈕啟用邏輯
- ✅ 修復：Matplotlib 中文字體配置問題
- ✅ 修復：Parquet 依賴問題（自動降級到 CSV）
- ✅ 修復：pandas sort_values 參數兼容性問題

### v1.0 (2025-12-16)
- ✅ 初始版本：完整的策略回測功能

