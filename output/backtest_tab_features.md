# 策略回測 Tab 功能清單

**生成時間**：2025-12-20  
**文件位置**：`ui_qt/views/backtest_view.py`

---

## 📋 功能分類總覽

### 1. 策略預設管理（Preset Management）

- ✅ **載入預設**：從下拉選單選擇已保存的策略預設
- ✅ **儲存預設**：將當前配置保存為預設
- ✅ **刪除預設**：刪除不需要的預設
- ✅ **預設下拉選單**：顯示所有可用的策略預設

---

### 2. 回測配置（Backtest Configuration）

#### 2.1 股票選擇模式
- ✅ **單一股票模式**：輸入單一股票代號（例如：2330）
- ✅ **選股清單模式**：從觀察清單（Watchlist）選擇股票清單
- ✅ **模式切換**：在單一股票和選股清單之間切換
- ✅ **觀察清單管理**：開啟觀察清單管理器

#### 2.2 時間範圍
- ✅ **開始日期選擇**：使用日期選擇器設定回測開始日期
- ✅ **結束日期選擇**：使用日期選擇器設定回測結束日期
- ✅ **日期格式**：yyyy-MM-dd

#### 2.3 資金與成本設定
- ✅ **初始資金**：設定回測初始資金（範圍：$10,000 - $100,000,000）
- ✅ **手續費設定**：以基點（bps）為單位設定手續費（範圍：0-1000 bps，預設：14.25 bps）
- ✅ **滑價設定**：以基點（bps）為單位設定滑價（範圍：0-1000 bps，預設：5.0 bps）

#### 2.4 執行價格設定（Phase 2.5 優先級 2）✅
- ✅ **執行價格模式選擇**：
  - 下一根K開盤價 (next_open) - 預設
  - 當根K收盤價 (close)

#### 2.5 停損停利設定（Phase 2.5 優先級 2）✅
- ✅ **停損停利模式選擇**：
  - 百分比模式
  - ATR 倍數模式
- ✅ **百分比模式**：
  - 停損百分比（範圍：0-50%，0 = 關閉）
  - 停利百分比（範圍：0-100%，0 = 關閉）
- ✅ **ATR 倍數模式**：
  - 停損 ATR 倍數（範圍：0-10 × ATR，0 = 關閉）
  - 停利 ATR 倍數（範圍：0-20 × ATR，0 = 關閉）
- ✅ **動態顯示/隱藏**：根據模式選擇自動顯示/隱藏對應的輸入框

---

### 3. 部位 Sizing 配置

- ✅ **Sizing 模式選擇**：
  - 全倉
  - 固定金額
  - 風險百分比
- ✅ **固定金額設定**：設定固定金額（範圍：$10,000 - $10,000,000，預設：$100,000）
- ✅ **風險百分比設定**：設定風險百分比（範圍：0.1-10%，預設：2.0%）
- ✅ **動態顯示/隱藏**：根據模式選擇自動顯示/隱藏對應的輸入框

---

### 4. 部位管理配置（Phase 2.5 優先級 2）✅

- ✅ **最大持有部位數**（Phase 2.5）：設定最多同時持有幾檔股票（範圍：1-50，1 = 無限制）
- ✅ **部位加權方式**（Phase 2.5）：
  - 等權重
  - 分數加權
  - 波動調整
- ✅ **允許加碼**：啟用/停用金字塔式建倉（複選框）
- ✅ **允許重新進場**：啟用/停用重新進場（複選框，預設：啟用）
- ✅ **重新進場冷卻天數**：設定重新進場的冷卻天數（範圍：0-30 天，預設：5 天）

---

### 5. 市場限制配置

- ✅ **漲跌停限制**：啟用/停用漲跌停限制（複選框，預設：啟用）
- ✅ **成交量約束**：啟用/停用成交量約束（複選框，預設：啟用）
- ✅ **最大參與率**：設定最大參與率（範圍：0.1-50%，預設：5.0%）

---

### 6. 策略配置

- ✅ **策略選擇**：從下拉選單選擇策略（動態載入可用策略）
- ✅ **策略參數表單**：根據選擇的策略動態顯示參數輸入表單
- ✅ **策略描述**：顯示當前選擇策略的描述說明
- ✅ **策略變更事件**：切換策略時自動更新參數表單

---

### 7. 參數最佳化（Optimization）

- ✅ **最佳化區塊開關**：可展開/收合最佳化配置區塊
- ✅ **目標指標選擇**：
  - 夏普比率
  - 年化報酬率
  - CAGR-MDD權衡
- ✅ **參數範圍設定**：根據策略動態生成參數範圍輸入表單
- ✅ **執行參數掃描**：執行 Grid Search 參數最佳化
- ✅ **最佳化進度顯示**：顯示最佳化進度（完成 x / y）

---

### 8. Walk-forward 驗證

- ✅ **Walk-forward 區塊開關**：可展開/收合 Walk-forward 配置區塊
- ✅ **驗證模式選擇**：
  - Train-Test Split
  - Walk-forward
- ✅ **Train-Test Split 設定**：
  - 訓練/測試比例（範圍：0.1-0.9，預設：0.7）
- ✅ **Walk-forward 設定**：
  - 訓練期（月）（範圍：1-24 月，預設：6 月）
  - 測試期（月）（範圍：1-12 月，預設：3 月）
  - 步進（月）（範圍：1-12 月，預設：3 月）
- ✅ **模式切換**：根據模式選擇動態顯示/隱藏對應設定
- ✅ **執行驗證**：執行 Walk-forward 驗證

---

### 9. 執行與進度

- ✅ **執行回測按鈕**：執行單一回測
- ✅ **保存結果按鈕**：保存回測結果到資料庫（初始禁用，回測完成後啟用）
- ✅ **進度條顯示**：顯示回測進度
- ✅ **進度文字顯示**：顯示當前進度狀態文字

---

### 10. 結果顯示（Results Tab）

#### 10.1 績效摘要
- ✅ **績效摘要文字**：顯示回測績效摘要（使用等寬字體）

#### 10.2 交易明細
- ✅ **交易明細表格**：顯示所有交易記錄
- ✅ **表格排序**：支援按欄位排序
- ✅ **行選擇**：支援選擇單行或多行
- ✅ **表格樣式**：交替行顏色、等寬字體

---

### 11. 圖表顯示（Charts Tab）

- ✅ **回測結果選擇**：從下拉選單選擇要顯示的回測結果
- ✅ **權益曲線圖**：顯示權益曲線圖表
- ✅ **回撤曲線圖**：顯示回撤曲線圖表
- ✅ **交易報酬分佈圖**：顯示交易報酬分佈直方圖
- ✅ **持有天數分佈圖**：顯示持有天數分佈直方圖
- ✅ **圖表 Tab 切換**：使用 Tab 組織 4 張圖表

---

### 12. 最佳化結果（Optimization Tab）

- ✅ **最佳化結果表格**：顯示 Grid Search 結果
- ✅ **表格排序**：支援按欄位排序
- ✅ **雙擊套用參數**：雙擊表格行自動套用該參數組合（Phase 2.5 優先級 2）✅
- ✅ **套用選中參數按鈕**：手動套用選中行的參數組合
- ✅ **進度回調顯示**：顯示最佳化進度（完成 x / y）（Phase 2.5 優先級 2）✅

---

### 13. 比較功能（Compare Tab）

- ✅ **回測歷史列表**：顯示所有已保存的回測結果
- ✅ **重新整理按鈕**：重新載入回測歷史
- ✅ **刪除選中按鈕**：刪除選中的回測結果（支援多選）
- ✅ **雙擊載入**：雙擊歷史項目載入該回測結果
- ✅ **比較選中按鈕**：比較選中的多個回測結果
- ✅ **多選支援**：支援選擇多個回測結果進行比較

---

## 🔍 Phase 2.5 Checklist 對照

### ✅ 優先級 1：立即修改（3/3 已完成）

1. ✅ **強勢/弱勢分數改成標準化或壓縮** - 不在 Backtest Tab，在 Market Watch Tab
2. ✅ **Pattern threshold/prominence 改成 ATR-based** - 不在 Backtest Tab，在分析模組
3. ✅ **Scoring contract 統一** - 不在 Backtest Tab，在推薦系統

### ✅ 優先級 2：短期（3/3 已完成）

1. ✅ **回測 execution_price 明確定義（next_open/close）**
   - ✅ UI 實現：`execution_price_combo` 提供選擇器
   - ✅ 功能位置：第 221-224 行
   - ✅ 狀態：**已完成**

2. ✅ **停損停利加入 ATR 倍數模式**
   - ✅ UI 實現：`stop_profit_mode_combo` 提供模式選擇
   - ✅ UI 實現：`stop_loss_atr_input` 和 `take_profit_atr_input` 提供 ATR 倍數輸入
   - ✅ 功能位置：第 227-269 行
   - ✅ 狀態：**已完成**

3. ✅ **加入 max_positions / position_sizing**
   - ✅ UI 實現：`max_positions_input` 提供最大持有部位數輸入
   - ✅ UI 實現：`position_sizing_combo` 提供部位加權方式選擇
   - ✅ 功能位置：第 310-320 行
   - ✅ 狀態：**已完成**

### ⚠️ 優先級 3：中期（0/3 未完成）

1. ⚠️ **指標參數改進** - 不在 Backtest Tab
2. ⚠️ **buy_score/sell_score 改為分位數** - 不在 Backtest Tab
3. ⚠️ **推薦系統參數改進** - 不在 Backtest Tab

### ⚠️ 優先級 4：長期（0/2 未完成）

1. ⚠️ **Walk-forward 暖機期參數** - Walk-forward 已實現，但暖機期參數未實現
2. ⚠️ **完整測試與驗證** - 優先級 1 和 2 已驗證通過

---

## 📊 Phase 2.5 相關功能完成度

### Backtest Tab 中的 Phase 2.5 功能

| 功能 | Phase 2.5 優先級 | 狀態 | 實現位置 |
|------|-----------------|------|---------|
| execution_price 選擇器 | 優先級 2 | ✅ 已完成 | 第 221-224 行 |
| 停損停利 ATR 模式 | 優先級 2 | ✅ 已完成 | 第 227-269 行 |
| max_positions | 優先級 2 | ✅ 已完成 | 第 310-314 行 |
| position_sizing | 優先級 2 | ✅ 已完成 | 第 317-320 行 |
| 最佳化進度回調 | 優先級 2 | ✅ 已完成 | Phase 2.5 驗證通過 |
| 雙擊套用參數 | 優先級 2 | ✅ 已完成 | 第 654-660 行 |

### Phase 2.5 核心部分完成度

- **優先級 1（立即修改）**：3/3 ✅ **100%**（不在 Backtest Tab）
- **優先級 2（短期）**：3/3 ✅ **100%**（Backtest Tab 相關功能全部完成）
- **優先級 3（中期）**：0/3 ❌ **0%**（不在 Backtest Tab）
- **優先級 4（長期）**：0/2 ❌ **0%**（Walk-forward 已實現，但暖機期參數未實現）

---

## 🎯 結論

### Backtest Tab 功能完整性

Backtest Tab 已實現**完整的回測功能**，包括：

1. ✅ **完整的回測配置**：股票選擇、時間範圍、資金成本、執行價格、停損停利、部位管理、市場限制
2. ✅ **策略配置與管理**：策略選擇、參數設定、預設管理
3. ✅ **參數最佳化**：Grid Search、進度顯示、參數套用
4. ✅ **Walk-forward 驗證**：Train-Test Split 和 Walk-forward 模式
5. ✅ **結果顯示**：績效摘要、交易明細、圖表、最佳化結果、歷史比較
6. ✅ **Phase 2.5 相關功能**：所有優先級 2 的功能都已實現

### Phase 2.5 Checklist 狀態

**核心部分（優先級 1 和 2）已 100% 完成**：

- ✅ 優先級 1：3/3 已完成（不在 Backtest Tab）
- ✅ 優先級 2：3/3 已完成（Backtest Tab 相關功能全部完成）
- ⚠️ 優先級 3：0/3 未完成（不在 Backtest Tab，移至 Phase 3）
- ⚠️ 優先級 4：0/2 未完成（Walk-forward 已實現，但暖機期參數未實現）

**結論**：**Phase 2.5 的核心部分（優先級 1 和 2）已經完成**，Backtest Tab 中所有 Phase 2.5 相關功能都已實現並通過驗證。

---

**報告生成時間**：2025-12-20

